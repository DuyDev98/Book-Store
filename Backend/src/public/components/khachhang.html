<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông tin khách hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body {
            background-color: #f8f9fa;
        }
        .profile-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 150px;
        }
        .profile-avatar {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 5px solid #fff;
            margin-top: -70px;
            object-fit: cover;
            background-color: #e9ecef;
        }
        .form-control:focus {
            box-shadow: none;
            border-color: #764ba2;
        }
        .btn-primary-custom {
            background: #764ba2;
            border: none;
            color: white;
        }
        .btn-primary-custom:hover {
            background: #5b3a7d;
            color: white;
        }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="profile-card">
                <div class="profile-header"></div>
                
                <div class="text-center">
                    <img src="https://via.placeholder.com/150" alt="Avatar" class="profile-avatar" id="avatarImg">
                    <h3 class="mt-3" id="displayHoTen">Đang tải...</h3>
                    <p class="text-muted" id="displayUsername">@username</p>
                </div>

                <div class="p-4">
                    <div id="alertMessage" class="alert d-none" role="alert"></div>

                    <form id="profileForm">
                        <div class="row g-3">
                            <div class="col-md-6 d-none">
                                <label class="form-label">Mã KH</label>
                                <input type="text" class="form-control" id="MaKH" readonly>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Tài khoản (Username)</label>
                                <input type="text" class="form-control bg-light" id="Username" readonly>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Họ và tên</label>
                                <input type="text" class="form-control" id="HoTen" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Email</label>
                                <input type="email" class="form-control" id="Email" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Số điện thoại</label>
                                <input type="tel" class="form-control" id="SDienThoai" required>
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Địa chỉ nhận hàng</label>
                                <textarea class="form-control" id="DiaChi" rows="2"></textarea>
                            </div>
                        </div>

                        <div class="mt-4 text-end">
                            <button type="button" class="btn btn-secondary me-2" onclick="loadUserData()">
                                <i class="fas fa-sync-alt"></i> Hủy / Tải lại
                            </button>
                            <button type="submit" class="btn btn-primary-custom px-4">
                                <i class="fas fa-save"></i> Lưu thay đổi
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ==========================================
    // CẤU HÌNH CỦA BẠN (SỬA Ở ĐÂY)
    // ==========================================
    const API_URL = 'http://localhost:5001/api/khachhang'; // Link API của bạn
    
    // Giả sử ID người dùng lấy từ LocalStorage (sau khi Login xong)
    // Nếu chưa có Login, hãy điền cứng ID đang có trong DB của bạn: const CURRENT_USER_ID = 1;
    const CURRENT_USER_ID = localStorage.getItem('userId') || 1; 
    // ==========================================

    // Hàm tiện ích hiển thị thông báo
    function showAlert(message, type = 'success') {
        const alertBox = document.getElementById('alertMessage');
        alertBox.className = `alert alert-${type} shadow-sm border-0 fade show`;
        alertBox.innerHTML = type === 'success' ? 
            `<i class="fas fa-check-circle me-2"></i> ${message}` : 
            `<i class="fas fa-exclamation-circle me-2"></i> ${message}`;
        alertBox.classList.remove('d-none');
        setTimeout(() => alertBox.classList.add('d-none'), 3000);
    }

    // Quản lý trạng thái nút bấm
    function setBtnLoading(isLoading) {
        const btnText = document.getElementById('btnText');
        const btnLoading = document.getElementById('btnLoading');
        const btn = document.getElementById('btnSave');
        
        if (isLoading) {
            btnText.classList.add('d-none');
            btnLoading.classList.remove('d-none');
            btn.disabled = true;
        } else {
            btnText.classList.remove('d-none');
            btnLoading.classList.add('d-none');
            btn.disabled = false;
        }
    }

    // --- HÀM 1: LẤY DỮ LIỆU TỪ SERVER ---
    async function loadUserData() {
        try {
            document.getElementById('displayHoTen').innerText = "Đang kết nối...";
            
            // Gọi API thật
            const response = await fetch(`${API_URL}/${CURRENT_USER_ID}`);
            
            // Kiểm tra lỗi HTTP (404, 500...)
            if (!response.ok) {
                throw new Error(`Lỗi kết nối: ${response.status} - ${response.statusText}`);
            }

            const data = await response.json();
            console.log("Dữ liệu nhận được:", data); // Xem log để debug nếu không hiện

            // Đổ dữ liệu vào ô input (Kiểm tra kỹ tên trường khớp với Backend)
            document.getElementById('MaKH').value = data.MaKH || ''; 
            document.getElementById('Username').value = data.Username || '';
            document.getElementById('HoTen').value = data.HoTen || '';
            document.getElementById('Email').value = data.Email || '';
            document.getElementById('SDienThoai').value = data.SDienThoai || '';
            document.getElementById('DiaChi').value = data.DiaChi || '';

            // Cập nhật hiển thị bên ngoài
            document.getElementById('displayHoTen').innerText = data.HoTen || 'Chưa đặt tên';
            document.getElementById('displayUsername').innerText = data.Username ? '@' + data.Username : '';
            
            // Avatar
            const avatarName = data.HoTen || "User";
            document.getElementById('avatarImg').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(avatarName)}&background=764ba2&color=fff&size=150`;

        } catch (error) {
            console.error("Lỗi tải trang:", error);
            showAlert("Không thể tải dữ liệu. Kiểm tra Console (F12) để xem chi tiết.", "danger");
            document.getElementById('displayHoTen').innerText = "Lỗi tải";
        }
    }

    // --- HÀM 2: CẬP NHẬT DỮ LIỆU LÊN SERVER ---
    document.getElementById('profileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        setBtnLoading(true);

        // Gom dữ liệu từ form
        const updateData = {
            MaKH: document.getElementById('MaKH').value, // Một số API yêu cầu gửi lại cả ID
            HoTen: document.getElementById('HoTen').value,
            Email: document.getElementById('Email').value,
            SDienThoai: document.getElementById('SDienThoai').value,
            DiaChi: document.getElementById('DiaChi').value,
            Username: document.getElementById('Username').value 
        };

        try {
            const response = await fetch(`${API_URL}/${CURRENT_USER_ID}`, {
                method: 'PUT', // Hoặc 'POST' tùy quy định Backend của bạn
                headers: {
                    'Content-Type': 'application/json'
                    // Nếu có Token xác thực thì thêm dòng dưới:
                    // 'Authorization': 'Bearer ' + localStorage.getItem('token') 
                },
                body: JSON.stringify(updateData)
            });

            if (!response.ok) {
                // Thử đọc lỗi từ server trả về
                const errData = await response.json().catch(() => ({}));
                throw new Error(errData.message || "Lỗi cập nhật từ Server");
            }

            // Thành công
            const result = await response.json().catch(() => {}); // Đọc kết quả nếu có
            
            // Cập nhật lại UI Avatar
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(updateData.HoTen)}&background=764ba2&color=fff&size=150`;
            document.getElementById('avatarImg').src = avatarUrl;
            document.getElementById('displayHoTen').innerText = updateData.HoTen;

            showAlert("Đã lưu thông tin thành công!");

        } catch (error) {
            console.error(error);
            showAlert(error.message, "danger");
        } finally {
            setBtnLoading(false);
        }
    });

    // Chạy ngay khi mở trang
    document.addEventListener('DOMContentLoaded', loadUserData);
</script>

</body>
</html>