<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Bán Sách</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script src="../../js/admin-guard.js"></script>
    <style>
      body {
        padding-top: 57px;
        background-color: #f5f6f8;
        margin-left: 240px;
        overflow-x: hidden;
      }

      .sidebar {
        position: fixed;
        top: 56px;
        bottom: 0;
        left: 0;
        z-index: 1000;
        padding: 20px 0;
        overflow-x: hidden;
        overflow-y: auto;
        background-color: #ffffff;
        border-right: 1px solid #dee2e6;
      }

      .sidebar .nav-link {
        color: #333;
        padding: 10px 20px;
        font-weight: 500;
      }

      .sidebar .nav-link i {
        margin-right: 8px;
      }

      .sidebar .nav-link.active {
        background-color: #0d6efd;
        color: #fff;
      }

      .sidebar .nav-link.active i {
        color: #fff;
      }

      .main-content {
        padding: 20px;
      }

      .card {
        border-radius: 0.5rem;
        border: 1px solid #e3e6ea;
        box-shadow: 0 2px 4px rgba(15, 34, 58, 0.05);
      }

      .table thead th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.04em;
      }

      /* Style cho cảnh báo tồn kho */
      .stock-warning {
        color: #dc3545;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Admin Bán Sách</a>

        <div class="d-flex ms-auto">
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <i class="bi bi-person-circle"></i> Chào, Admin!
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="navbarDropdown"
              >
                <li>
                  <a
                    class="dropdown-item text-danger"
                    href="#"
                    onclick="adminLogout()"
                    >Đăng xuất</a
                  >
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <nav class="col-md-3 col-lg-2 d-md-block sidebar" style="width: 240px">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" href="dashboard.html">
                <i class="bi bi-house-door"></i> Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_sach.html">
                <i class="bi bi-book"></i> Quản lý Sách
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_loai_sach.html">
                <i class="bi bi-tags"></i> Quản lý Loại sách
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_nxb.html">
                <i class="bi bi-building"></i> Quản lý NXB
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_don_hang.html">
                <i class="bi bi-cart"></i> Quản lý Đơn hàng
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_tac_gia.html">
                <i class="bi bi-people"></i> Quản lý Tác giả
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_danh_muc.html">
                <i class="bi bi-list-task"></i> Quản lý Danh mục
              </a>
            </li>
          </ul>
        </nav>

        <main class="main-content">
          <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
          >
            <h1 class="h2">Dashboard</h1>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-xl-4 col-md-6">
              <div class="card text-white bg-primary">
                <div class="card-body">
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <div class="me-3">
                      <div class="text-white-75 small">
                        Đơn hàng (Tháng này)
                      </div>
                      <div class="display-6 fw-bold" id="monthlyOrderCount">
                        0
                      </div>
                    </div>
                    <i
                      class="bi bi-cart-check-fill"
                      style="font-size: 3rem"
                    ></i>
                  </div>
                </div>
                <div
                  class="card-footer d-flex align-items-center justify-content-between small"
                >
                  <a
                    class="text-white stretched-link"
                    href="quan_li_don_hang.html"
                    >Xem chi tiết</a
                  >
                  <div class="text-white">
                    <i class="bi bi-chevron-right"></i>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-xl-4 col-md-6">
              <div class="card text-white bg-success">
                <div class="card-body">
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <div class="me-3">
                      <div class="text-white-75 small">
                        Doanh thu (Tháng này)
                      </div>
                      <div class="display-6 fw-bold" id="monthlyRevenue">
                        0 đ
                      </div>
                    </div>
                    <i class="bi bi-cash-coin" style="font-size: 3rem"></i>
                  </div>
                </div>
                <div
                  class="card-footer d-flex align-items-center justify-content-between small"
                >
                  <a class="text-white stretched-link" href="#">Xem báo cáo</a>
                  <div class="text-white">
                    <i class="bi bi-chevron-right"></i>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-xl-4 col-md-6">
              <div class="card text-white bg-warning">
                <div class="card-body">
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <div class="me-3">
                      <div class="text-dark small fw-bold">
                        Sách sắp hết hàng
                      </div>
                      <div
                        class="display-6 fw-bold text-dark"
                        id="lowStockCount"
                      >
                        ...
                      </div>
                    </div>
                    <i
                      class="bi bi-exclamation-triangle-fill text-dark"
                      style="font-size: 3rem"
                    ></i>
                  </div>
                </div>
                <div
                  class="card-footer d-flex align-items-center justify-content-between small"
                >
                  <a
                    class="text-dark fw-bold stretched-link"
                    href="#stockAlertSection"
                    >Nhập hàng ngay</a
                  >
                  <div class="text-dark">
                    <i class="bi bi-chevron-right"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-lg-7">
              <div class="card h-100">
                <div class="card-header">
                  <i class="bi bi-graph-up me-1"></i>
                  Biểu đồ Doanh thu (7 ngày qua)
                </div>
                <div class="card-body">
                  <canvas id="revenueChart" style="max-height: 300px"></canvas>
                </div>
              </div>
            </div>

            <div class="col-lg-5">
              <div class="card h-100">
                <div class="card-header">
                  <i class="bi bi-pie-chart-fill me-1"></i>
                  Tỷ lệ Sách bán chạy
                </div>
                <div class="card-body">
                  <div
                    style="
                      height: 300px;
                      display: flex;
                      justify-content: center;
                    "
                  >
                    <canvas id="bestsellerChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-7">
              <div class="card h-100">
                <div
                  class="card-header d-flex justify-content-between align-items-center"
                >
                  <span
                    ><i class="bi bi-table me-1"></i> Đơn hàng mới nhất</span
                  >
                  <button
                    class="btn btn-sm btn-success"
                    onclick="exportOrdersToExcel()"
                  >
                    <i class="bi bi-file-earmark-excel"></i> Xuất Excel
                  </button>
                </div>
                <div class="card-body">
                  <table class="table table-striped table-sm table-hover">
                    <thead>
                      <tr>
                        <th>Mã ĐH</th>
                        <th>Khách hàng</th>
                        <th>Tổng tiền</th>
                        <th>Trạng thái</th>
                      </tr>
                    </thead>
                    <tbody id="recentOrdersTable">
                      <tr>
                        <td colspan="4" class="text-center">Đang tải...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="col-lg-5" id="stockAlertSection">
              <div class="card h-100 border-warning">
                <div
                  class="card-header bg-warning-subtle text-dark d-flex justify-content-between align-items-center"
                >
                  <span>
                    <i
                      class="bi bi-exclamation-octagon-fill me-1 text-danger"
                    ></i>
                    <strong>Cảnh báo Nhập hàng (Tồn < 10)</strong>
                  </span>
                  <button
                    class="btn btn-sm btn-outline-dark"
                    onclick="exportStockToExcel()"
                  >
                    <i class="bi bi-file-earmark-arrow-down"></i> Tải danh sách
                  </button>
                </div>
                <div class="card-body p-0">
                  <div
                    class="table-responsive"
                    style="max-height: 300px; overflow-y: auto"
                  >
                    <table class="table table-hover mb-0">
                      <thead class="table-light">
                        <tr>
                          <th>Tên sách</th>
                          <th class="text-center">Tồn kho</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody id="stockAlertTable">
                        <tr>
                          <td colspan="3" class="text-center">
                            Đang kiểm tra kho...
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="card-footer bg-white text-center">
                  <a href="quan_li_sach.html" class="btn btn-sm btn-outline-danger">Đến trang Quản lý kho</a>
                </div>
              </div>
            </div>
          </div> 
        </main>

      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // CẤU HÌNH API
      const API_BASE = "http://localhost:5001/api";
      const API_URL_ORDERS = `${API_BASE}/orders`;
      const API_URL_BOOKS = `${API_BASE}/sach`; // API quản lý sách

      // --- HÀM TIỆN ÍCH ---
      const formatMoney = (amount) =>
        new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(amount);

      const getStatusBadge = (status) => {
        switch (status) {
          case "Chờ xác nhận":
            return '<span class="badge bg-warning text-dark">Chờ xác nhận</span>';
          case "Đang xử lý":
            return '<span class="badge bg-info">Đang xử lý</span>';
          case "Đang giao":
            return '<span class="badge bg-primary">Đang giao</span>';
          case "Đã giao":
            return '<span class="badge bg-success">Đã giao</span>';
          case "Đã hủy":
            return '<span class="badge bg-danger">Đã hủy</span>';
          default:
            return `<span class="badge bg-secondary">${status}</span>`;
        }
      };

      function getLast7Days() {
        const dates = [];
        for (let i = 6; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          dates.push(d);
        }
        return dates;
      }

      // --- LOGIC CHÍNH ---
      document.addEventListener("DOMContentLoaded", () => {
        loadDashboardData();
        initBestSellerChart();
        loadStockAlerts(); // Load dữ liệu thật từ API
      });

      async function loadDashboardData() {
        try {
          const res = await fetch(API_URL_ORDERS);
          const orders = await res.json();
          renderRecentOrders(orders);
          calculateAndDrawRevenue(orders);
          updateMonthlyStats(orders);
        } catch (error) {
          console.error("Lỗi tải dữ liệu đơn hàng:", error);
          document.getElementById("recentOrdersTable").innerHTML =
            '<tr><td colspan="4" class="text-center text-danger">Lỗi kết nối API</td></tr>';
        }
      }
      function updateMonthlyStats(orders) {
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        // 1. Lọc các đơn hàng thuộc tháng hiện tại và năm hiện tại
        const monthlyOrders = orders.filter((order) => {
          const orderDate = new Date(order.NgayDat);
          return (
            orderDate.getMonth() === currentMonth &&
            orderDate.getFullYear() === currentYear
          );
        });

        // 2. Hiển thị tổng số đơn hàng trong tháng
        document.getElementById("monthlyOrderCount").innerText =
          monthlyOrders.length;

        // 3. Tính tổng doanh thu tháng (Chỉ tính các đơn "Đã giao")
        const totalRevenue = monthlyOrders.reduce((sum, order) => {
          const isDelivered =
            order.TrangThai &&
            order.TrangThai.trim().toLowerCase() === "đã giao";

          if (isDelivered) {
            const price = Number(order.TongTien) || 0;
            return sum + price;
            y;
          }
          return sum;
        }, 0);

        // 4. Hiển thị doanh thu đã format (sử dụng hàm formatMoney có sẵn của bạn)
        document.getElementById("monthlyRevenue").innerText =
          formatMoney(totalRevenue);
      }
      function calculateAndDrawRevenue(orders) {
        const last7Days = getLast7Days();
        const dataRevenue = [];
        const labels = [];

        last7Days.forEach((dateObj) => {
          // Lấy ngày/tháng để hiển thị label (ví dụ: 27/12)
          const dateStr = dateObj.toLocaleDateString("vi-VN", {
            day: "2-digit",
            month: "2-digit",
          });
          labels.push(dateStr);

          // Chuẩn hóa dateObj về dạng YYYY-MM-DD theo giờ địa phương
          const d = dateObj;
          const checkDate = `${d.getFullYear()}-${String(
            d.getMonth() + 1
          ).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;

          const dailyTotal = orders.reduce((sum, order) => {
            // Chuẩn hóa ngày của đơn hàng về YYYY-MM-DD theo giờ địa phương
            const oD = new Date(order.NgayDat);
            const orderDate = `${oD.getFullYear()}-${String(
              oD.getMonth() + 1
            ).padStart(2, "0")}-${String(oD.getDate()).padStart(2, "0")}`;

            // Kiểm tra trạng thái "Đã giao" (không phân biệt hoa thường, khoảng trắng)
            const isDelivered =
              order.TrangThai &&
              order.TrangThai.trim().toLowerCase() === "đã giao";

            if (orderDate === checkDate && isDelivered) {
              const price =
                typeof order.TongTien === "string"
                  ? parseFloat(order.TongTien.replace(/,/g, "")) // Nếu là chuỗi, xóa dấu phẩy ngăn cách nghìn
                  : Number(order.TongTien); // Nếu đã là số, giữ nguyên

              return sum + (price || 0);
            }
            return sum;
          }, 0);

          dataRevenue.push(dailyTotal);
        });

        const ctx = document.getElementById("revenueChart").getContext("2d");

        if (window.myRevenueChart) {
          window.myRevenueChart.destroy();
        }

        window.myRevenueChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Doanh thu (VNĐ)",
                data: dataRevenue,
                borderColor: "#0d6efd",
                backgroundColor: "rgba(13, 110, 253, 0.2)",
                borderWidth: 3,
                pointBackgroundColor: "#0d6efd",
                fill: true,
                tension: 0.3,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: (value) => value.toLocaleString("vi-VN") + " đ",
                },
              },
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: (context) =>
                    `Doanh thu: ${context.parsed.y.toLocaleString("vi-VN")} đ`,
                },
              },
            },
          },
        });
      }
      function renderRecentOrders(orders) {
        const recentOrders = orders.slice(0, 5);
        const tbody = document.getElementById("recentOrdersTable");
        tbody.innerHTML = "";

        recentOrders.forEach((order) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td>#${order.MaDH}</td>
                    <td>${order.HoTen}</td>
                    <td>${formatMoney(order.TongTien)}</td>
                    <td>${getStatusBadge(order.TrangThai)}</td>
                `;
          tbody.appendChild(tr);
        });
      }

      async function initBestSellerChart() {
        const chartElement = document.getElementById("bestsellerChart");
        if (!chartElement) return;

        try {
          const res = await fetch(`${API_URL_ORDERS}/best-sellers`);
          const data = await res.json();

          if (!data || data.length === 0) return;

          const labels = data.map((item) => item.TenSach);
          const values = data.map((item) => item.TongSoLuong);

          new Chart(chartElement.getContext("2d"), {
            type: "doughnut",
            data: {
              labels: labels,
              datasets: [
                {
                  data: values,
                  backgroundColor: [
                    "#0d6efd",
                    "#198754",
                    "#ffc107",
                    "#dc3545",
                    "#6c757d",
                  ],
                  hoverOffset: 4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                  labels: { boxWidth: 12, font: { size: 11 } },
                },
              },
            },
          });
        } catch (error) {
          console.error("Lỗi tải biểu đồ sách:", error);
        }
      }

      // --- XỬ LÝ SÁCH SẮP HẾT & NHẬP HÀNG (REAL-TIME API) ---

      async function loadStockAlerts() {
        const tbody = document.getElementById("stockAlertTable");
        const countElement = document.getElementById("lowStockCount");

        try {
          // Gọi API lấy danh sách sách sắp hết (Cần backend trả về {count, items})
          const res = await fetch(`${API_URL_BOOKS}/thong-ke/sap-het-hang`);
          const data = await res.json();

          const count = data.count || 0;
          const items = data.items || [];

          countElement.innerText = count;
          tbody.innerHTML = "";

          if (items.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="3" class="text-center text-muted">Kho hàng ổn định</td></tr>';
            return;
          }

          items.forEach((book) => {
            const tr = document.createElement("tr");
            // Tồn = 0 thì chữ đậm màu đỏ, còn lại chữ đỏ thường
            const stockClass =
              book.SoLuongTon === 0 ? "text-danger fw-bold" : "text-danger";

            tr.innerHTML = `
                        <td>
                            <span class="d-block text-truncate" style="max-width: 150px;" title="${book.TenSach}">${book.TenSach}</span>
                        </td>
                        <td class="text-center ${stockClass}">${book.SoLuongTon}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-primary py-0" onclick="openImportModal(${book.MaSach}, '${book.TenSach}')">Nhập</button>
                        </td>
                    `;
            tbody.appendChild(tr);
          });
        } catch (error) {
          console.error("Lỗi load tồn kho:", error);
          tbody.innerHTML =
            '<tr><td colspan="3" class="text-danger text-center">Lỗi kết nối API</td></tr>';
          countElement.innerText = "!";
        }
      }

      // Hàm mở Popup nhập hàng (Dùng SweetAlert2)
      window.openImportModal = async (id, name) => {
        const { value: quantity } = await Swal.fire({
          title: "Nhập hàng",
          html: `Nhập số lượng thêm cho:<br><b>${name}</b>`,
          input: "number",
          inputAttributes: { min: 1, step: 1 },
          showCancelButton: true,
          confirmButtonText: "Xác nhận",
          cancelButtonText: "Hủy",
        });

        if (quantity) {
          try {
            // Gọi API cập nhật tồn kho
            const res = await fetch(`${API_URL_BOOKS}/${id}/nhap-hang`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ soLuong: parseInt(quantity) }),
            });

            if (res.ok) {
              Swal.fire("Thành công!", "Đã nhập thêm hàng.", "success");
              loadStockAlerts(); // Load lại bảng để cập nhật số liệu
            } else {
              Swal.fire("Lỗi!", "Không thể nhập hàng.", "error");
            }
          } catch (err) {
            Swal.fire("Lỗi server!", err.message, "error");
          }
        }
      };

      // --- TÍNH NĂNG XUẤT EXCEL (SheetJS) ---

      // Hàm chung hỗ trợ xuất Excel
      function exportToExcel(data, fileName, sheetName) {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
        XLSX.writeFile(wb, `${fileName}.xlsx`);
      }

      // 1. Xuất danh sách Đơn hàng
      async function exportOrdersToExcel() {
        try {
          // Lấy lại danh sách đơn hàng
          const res = await fetch(API_URL_ORDERS);
          const orders = await res.json();

          if (!orders || orders.length === 0) {
            Swal.fire("Thông báo", "Không có đơn hàng nào để xuất.", "info");
            return;
          }

          // Định dạng lại dữ liệu cho đẹp
          const dataToExport = orders.map((o) => ({
            "Mã ĐH": o.MaDH,
            "Khách hàng": o.HoTen,
            "Tổng tiền": o.TongTien,
            "Ngày đặt": new Date(o.NgayDat).toLocaleDateString("vi-VN"),
            "Trạng thái": o.TrangThai,
          }));

          exportToExcel(dataToExport, "Danh_Sach_Don_Hang", "DonHang");
        } catch (err) {
          console.error(err);
          Swal.fire("Lỗi", "Không thể xuất file Excel.", "error");
        }
      }

      // 2. Xuất danh sách Cảnh báo Tồn kho
      async function exportStockToExcel() {
        try {
          const res = await fetch(`${API_URL_BOOKS}/thong-ke/sap-het-hang`);
          const data = await res.json();
          const items = data.items || [];

          if (items.length === 0) {
            Swal.fire(
              "Thông báo",
              "Kho hàng ổn định, không có dữ liệu để xuất.",
              "info"
            );
            return;
          }

          const dataToExport = items.map((book) => ({
            "Mã sách": book.MaSach,
            "Tên sách": book.TenSach,
            "Số lượng tồn": book.SoLuongTon,
            "Giá bán": book.GiaBan,
          }));

          exportToExcel(dataToExport, "Canh_Bao_Nhap_Hang", "SachSapHet");
        } catch (err) {
          console.error(err);
          Swal.fire("Lỗi", "Không thể xuất file Excel.", "error");
        }
      }
    </script>
  </body>
</html>