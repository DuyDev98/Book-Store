<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Bán Sách</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="../../js/admin-guard.js"></script>

    <style>
        body {
            padding-top: 57px;
            background-color: #f5f6f8;
            margin-left: 240px; /* Chừa chỗ cho sidebar */
            overflow-x: hidden;
        }

        /* Sidebar cố định bên trái */
        .sidebar {
            position: fixed;
            top: 56px;
            bottom: 0;
            left: 0;
            z-index: 1000;
            padding: 20px 0;
            overflow-x: hidden;
            overflow-y: auto;
            background-color: #ffffff;
            border-right: 1px solid #dee2e6;
        }

        .sidebar .nav-link {
            color: #333;
            padding: 10px 20px;
            font-weight: 500;
        }

        .sidebar .nav-link i {
            margin-right: 8px;
        }

        .sidebar .nav-link.active {
            background-color: #0d6efd;
            color: #fff;
        }

        .sidebar .nav-link.active i {
            color: #fff;
        }

        .main-content {
            padding: 20px;
        }

        .card {
            border-radius: 0.5rem;
            border: 1px solid #e3e6ea;
            box-shadow: 0 2px 4px rgba(15, 34, 58, 0.05);
        }

        .table thead th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.04em;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Admin Bán Sách</a>

            <div class="d-flex ms-auto">
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i> Chào, Admin!
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item text-danger" href="#" onclick="adminLogout()">Đăng xuất</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">

            <nav class="col-md-3 col-lg-2 d-md-block sidebar" style="width: 240px;">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard.html">
                            <i class="bi bi-house-door"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_sach.html">
                            <i class="bi bi-book"></i> Quản lý Sách
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_loai_sach.html">
                            <i class="bi bi-tags"></i> Quản lý Loại sách
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_nxb.html">
                            <i class="bi bi-building"></i> Quản lý NXB
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_don_hang.html">
                            <i class="bi bi-cart"></i> Quản lý Đơn hàng
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_binh_luan.html">
                            <i class="bi bi-chat-dots"></i> Quản lý Bình luận
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_tac_gia.html">
                            <i class="bi bi-people"></i> Quản lý tác giả
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link " href="quan_li_danh_muc.html">
                            <i class="bi bi-list-task"></i> Quản lý Danh mục
                        </a>
                    </li>
                </ul>
            </nav>

            <main class="main-content">

                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Dashboard</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-secondary">Chia sẻ</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary">Xuất file</button>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-xl-4 col-md-6">
                        <div class="card text-white bg-primary h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="me-3">
                                        <div class="text-white-75 small">Đơn hàng (Tháng này)</div>
                                        <div class="display-6 fw-bold">124</div>
                                    </div>
                                    <i class="bi bi-cart-check-fill" style="font-size: 3rem;"></i>
                                </div>
                            </div>
                            <div class="card-footer d-flex align-items-center justify-content-between small">
                                <a class="text-white stretched-link text-decoration-none" href="quan_li_don_hang.html">Xem chi tiết</a>
                                <div class="text-white"><i class="bi bi-chevron-right"></i></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-4 col-md-6">
                        <div class="card text-white bg-success h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="me-3">
                                        <div class="text-white-75 small">Doanh thu (Tháng này)</div>
                                        <div class="display-6 fw-bold">8.5Tr</div>
                                    </div>
                                    <i class="bi bi-cash-coin" style="font-size: 3rem;"></i>
                                </div>
                            </div>
                            <div class="card-footer d-flex align-items-center justify-content-between small">
                                <a class="text-white stretched-link text-decoration-none" href="#">Xem báo cáo</a>
                                <div class="text-white"><i class="bi bi-chevron-right"></i></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-4 col-md-6">
                        <div class="card text-dark bg-warning h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="me-3">
                                        <div class="small fw-bold">Sách sắp hết hàng</div>
                                        <div class="display-6 fw-bold" id="low-stock-count">...</div> 
                                        <div class="small">(Tồn kho < 10)</div>
                                    </div>
                                    <i class="bi bi-exclamation-triangle-fill" style="font-size: 3rem; opacity: 0.5"></i>
                                </div>
                            </div>
                            <div class="card-footer d-flex align-items-center justify-content-between small">
                                <a class="text-dark fw-bold stretched-link text-decoration-none" href="quan_li_sach.html">Nhập hàng ngay</a>
                                <div class="text-dark"><i class="bi bi-chevron-right"></i></div>
                            </div>
                        </div>
                    </div>
                </div> 

                <div class="row g-3 mb-3">
                    <div class="col-lg-7">
                        <div class="card h-100">
                            <div class="card-header">
                                <i class="bi bi-graph-up me-1"></i>
                                Biểu đồ Doanh thu (7 ngày qua)
                            </div>
                            <div class="card-body">
                                <canvas id="revenueChart" style="max-height: 300px; width: 100%;"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-5">
                        <div class="card h-100">
                            <div class="card-header">
                                <i class="bi bi-pie-chart-fill me-1"></i>
                                Tỷ lệ Sách bán chạy
                            </div>
                            <div class="card-body d-flex justify-content-center">
                                <div style="width: 100%; max-width: 350px;">
                                    <canvas id="topBookChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> 

                <div class="row g-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-table me-1"></i>
                                Đơn hàng mới nhất
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm table-hover align-middle">
                                        <thead>
                                            <tr>
                                                <th>Mã ĐH</th>
                                                <th>Khách hàng</th>
                                                <th>Ngày đặt</th>
                                                <th>Tổng tiền</th>
                                                <th>Trạng thái</th>
                                                <th class="text-end">Hành động</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>#12034</td>
                                                <td>Nguyễn Văn An</td>
                                                <td>12/12/2023</td>
                                                <td>229,000đ</td>
                                                <td><span class="badge bg-warning text-dark">Chờ xác nhận</span></td>
                                                <td class="text-end"><button class="btn btn-sm btn-outline-primary">Xem</button></td>
                                            </tr>
                                            <tr>
                                                <td>#12033</td>
                                                <td>Trần Thị Bích</td>
                                                <td>11/12/2023</td>
                                                <td>79,000đ</td>
                                                <td><span class="badge bg-info">Đang xử lý</span></td>
                                                <td class="text-end"><button class="btn btn-sm btn-outline-primary">Xem</button></td>
                                            </tr>
                                            <tr>
                                                <td>#12032</td>
                                                <td>Lê Minh Hoàng</td>
                                                <td>10/12/2023</td>
                                                <td>510,000đ</td>
                                                <td><span class="badge bg-primary">Đang giao</span></td>
                                                <td class="text-end"><button class="btn btn-sm btn-outline-primary">Xem</button></td>
                                            </tr>
                                            <tr>
                                                <td>#12031</td>
                                                <td>Phạm Văn Cường</td>
                                                <td>09/12/2023</td>
                                                <td>1,250,000đ</td>
                                                <td><span class="badge bg-success">Đã giao</span></td>
                                                <td class="text-end"><button class="btn btn-sm btn-outline-primary">Xem</button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <div class="modal fade" id="feedbackModal" tabindex="-1" aria-hidden="true">
         <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chi tiết Phản hồi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body"><p>Nội dung...</p></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 1. Hàm lấy số lượng sách sắp hết hàng
       async function fetchLowStockCount() {
    const countElement = document.getElementById("low-stock-count");
    try {
        // [CẬP NHẬT] Gọi đúng API vừa tạo ở Backend
        const res = await fetch('/api/sach/thong-ke/sap-het-hang');
        
        if (!res.ok) throw new Error("Lỗi kết nối");

        const data = await res.json();
        
        // Backend trả về { count: 5 } nên ta lấy data.count
        countElement.innerText = data.count || 0; 

        // Nếu số lượng > 0 thì đổi màu chữ thành đỏ cho nổi bật
        if(data.count > 0) {
            countElement.classList.add("text-danger");
        }
        
    } catch (error) {
        console.error("Lỗi lấy dữ liệu:", error);
        countElement.innerText = "-";
    }
}

        // 2. Hàm vẽ biểu đồ (Sử dụng Chart.js)
        async function loadCharts() {
            try {
                // --- DỮ LIỆU GIẢ LẬP ---
                // Khi có API thì thay bằng fetch('/api/sach/thong-ke/bieu-do')
                const data = {
                    revenue: [
                        { Ngay: '06/12', DoanhThu: 1500000 },
                        { Ngay: '07/12', DoanhThu: 2300000 },
                        { Ngay: '08/12', DoanhThu: 1200000 },
                        { Ngay: '09/12', DoanhThu: 3500000 },
                        { Ngay: '10/12', DoanhThu: 900000 },
                        { Ngay: '11/12', DoanhThu: 2100000 },
                        { Ngay: '12/12', DoanhThu: 1800000 },
                    ],
                    topSelling: [
                        { TenSach: 'Nhà Giả Kim', DaBan: 45 },
                        { TenSach: 'Đắc Nhân Tâm', DaBan: 30 },
                        { TenSach: 'Harry Potter', DaBan: 25 },
                        { TenSach: 'Dế Mèn', DaBan: 15 },
                        { TenSach: 'Mắt Biếc', DaBan: 10 }
                    ]
                };

                // A. Vẽ biểu đồ Doanh thu (Line Chart)
                const ctxRev = document.getElementById('revenueChart');
                new Chart(ctxRev, {
                    type: 'line', 
                    data: {
                        labels: data.revenue.map(item => item.Ngay),
                        datasets: [{
                            label: 'Doanh thu (VNĐ)',
                            data: data.revenue.map(item => item.DoanhThu),
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });

                // B. Vẽ biểu đồ Sách bán chạy (Doughnut Chart)
                const ctxPie = document.getElementById('topBookChart');
                new Chart(ctxPie, {
                    type: 'doughnut',
                    data: {
                        labels: data.topSelling.map(item => item.TenSach),
                        datasets: [{
                            data: data.topSelling.map(item => item.DaBan),
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'
                            ],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });

            } catch (error) {
                console.error("Lỗi vẽ biểu đồ:", error);
            }
        }

        // 3. Khởi chạy khi trang tải xong
        document.addEventListener("DOMContentLoaded", () => {
            fetchLowStockCount();
            loadCharts();
        });

        // 4. Hàm Logout
        function adminLogout() {
            if(confirm("Bạn có chắc chắn muốn đăng xuất?")) {
                localStorage.removeItem("adminToken"); // Xóa token nếu có
                window.location.href = "login.html";   // Chuyển hướng
            }
        }
    </script>
</body>
</html>