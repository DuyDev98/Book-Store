<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Quản lý Tác giả</title>

    <!-- BOOTSTRAP CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="../../js/admin-guard.js"></script>

    <style>
        body {
            padding-top: 57px;
            background-color: #f5f6f8;
            margin-left: 240px;
            overflow-x: hidden; /* Ẩn thanh cuộn ngang của toàn trang */
        }

        .sidebar {
            position: fixed;
            top: 56px;
            bottom: 0;
            left: 0;
            z-index: 1000;
            padding: 20px 0;
            overflow-x: hidden;
            overflow-y: auto;
            background-color: #ffffff;
            border-right: 1px solid #dee2e6;
        }

        .sidebar .nav-link {
            color: #333;
            padding: 10px 20px;
            font-weight: 500;
        }

        .sidebar .nav-link i {
            margin-right: 8px;
        }

        .sidebar .nav-link.active {
            background-color: #0d6efd;
            color: #fff;
        }

        .sidebar .nav-link.active i {
            color: #fff;
        }

        .main-content {
            
            padding: 20px;
        }

        .card {
            border-radius: 0.5rem;
            border: 1px solid #e3e6ea;
            box-shadow: 0 2px 4px rgba(15, 34, 58, 0.05);
        }

        .table thead th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.04em;
        }
    </style>
</head>
<body>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Admin Bán Sách</a>

            <div class="d-flex ms-auto">
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown"
                           role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i> Chào, Admin!
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#">Thông tin cá nhân</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#">Đăng xuất</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- LAYOUT CHUNG -->
    <div class="container-fluid">
        <div class="row">

            <!-- SIDEBAR -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar" style="width: 240px;">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="bi bi-house-door"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_sach.html">
                            <i class="bi bi-book"></i> Quản lý Sách
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_loai_sach.html">
                            <i class="bi bi-tags"></i> Quản lý Loại sách
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_nxb.html">
                            <i class="bi bi-building"></i> Quản lý NXB
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_don_hang.html">
                            <i class="bi bi-cart"></i> Quản lý Đơn hàng
                        </a>
                    </li>
                 
                    
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_binh_luan.html">
                            <i class="bi bi-chat-dots"></i> Quản lý Bình luận
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_phan_hoi.html">
                            <i class="bi bi-envelope"></i> Quản lý Phản hồi
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_tac_gia.html">
                            <i class="bi bi-people"></i> Quản lý tác giả
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="quan_li_danh_muc.html">
                            <i class="bi bi-list-task"></i> Quản lý Danh mục
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- MAIN CONTENT -->
            <main class="main-content">

                <!-- TIÊU ĐỀ + NÚT THÊM -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <div>
                        <h1 class="h2 mb-0">Quản lý Tác giả</h1>
                        <small class="text-muted">Quản lý danh sách tác giả, năm sinh, quê quán, năm mất,…</small>
                    </div>
                    <button id="openAddAuthorBtn"
                            class="btn btn-primary"
                            data-bs-toggle="modal"
                            data-bs-target="#authorModal">
                        <i class="bi bi-plus-circle"></i> Thêm tác giả
                    </button>
                </div>

                <!-- BẢNG TÁC GIẢ -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 8%;">Mã TG</th>
                                        <th style="width: 24%;">Tên tác giả</th>
                                        <th style="width: 15%;">Năm sinh</th>
                                        <th style="width: 20%;">Quê quán</th>
                                        <th style="width: 15%;">Năm mất</th>
                                        <th class="text-center" style="width: 18%;">Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="authorTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- MODAL THÊM / SỬA TÁC GIẢ -->
    <div class="modal fade" id="authorModal" tabindex="-1" aria-labelledby="authorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content shadow-lg rounded-3">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="authorModalLabel">Thông tin Tác giả</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body p-4">
                    <form id="authorForm" class="row g-3">
                        <div class="col-md-4">
                            <label for="authorCode" class="form-label fw-semibold">Mã tác giả</label>
                            <input type="text" class="form-control shadow-sm" id="authorCode" placeholder="Tự tăng" disabled>
                        </div>

                        <div class="col-md-8">
                            <label for="authorName" class="form-label fw-semibold">Tên tác giả</label>
                            <input type="text" class="form-control shadow-sm" id="authorName" placeholder="Nhập tên tác giả..." required>
                        </div>

                        <div class="col-md-4">
                            <label for="authorBirth" class="form-label fw-semibold">Năm sinh</label>
                            <input type="number" class="form-control shadow-sm" id="authorBirth" placeholder="VD: 1990">
                        </div>

                        <div class="col-md-4">
                            <label for="authorDeath" class="form-label fw-semibold">Năm mất</label>
                            <input type="number" class="form-control shadow-sm" id="authorDeath" placeholder="Nếu còn sống thì để trống">
                        </div>

                        <div class="col-md-4">
                            <label for="authorQueQuan" class="form-label fw-semibold">Quê quán</label>
                            <input type="text" class="form-control shadow-sm" id="authorQueQuan" placeholder="VD: Việt Nam">
                        </div>
                    </form>
                </div>

                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary px-4" id="saveAuthorButton">Lưu lại</button>
                </div>
            </div>
        </div>
    </div>

    <!-- BOOTSTRAP JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SCRIPT GỌI API TÁC GIẢ -->
    <script>
    let allAuthors = [];
    let isEditing = false;
    let editingId = null;

    document.addEventListener("DOMContentLoaded", () => {
        loadAuthors();

        const addBtn  = document.getElementById("openAddAuthorBtn");
        const saveBtn = document.getElementById("saveAuthorButton");
        const form    = document.getElementById("authorForm");

        // Mở modal ở chế độ THÊM
        addBtn.addEventListener("click", () => {
            isEditing = false;
            editingId = null;
            form.reset();
            document.getElementById("authorCode").value   = "";
            document.getElementById("authorModalLabel").textContent = "Thêm tác giả";
        });

        // Lưu (THÊM hoặc SỬA)
        saveBtn.addEventListener("click", async () => {
            const TenTG   = document.getElementById("authorName").value.trim();
            const NamSinh = document.getElementById("authorBirth").value || null;
            const NamMat  = document.getElementById("authorDeath").value || null;
            const QueQuan = document.getElementById("authorQueQuan").value || null;

            if (!TenTG) {
                alert("Vui lòng nhập tên tác giả");
                return;
            }

            try {
                let url  = "/api/tacgia";
                let method = "POST";

                if (isEditing && editingId != null) {
                    url    = `/api/tacgia/${editingId}`;
                    method = "PUT";
                }

                const res = await fetch(url, {
                    method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ TenTG, NamSinh, NamMat, QueQuan })
                });

                if (!res.ok) {
                    const txt = await res.text();
                    console.error("Lỗi lưu tác giả:", txt);
                    alert("Không thể lưu tác giả");
                    return;
                }

                bootstrap.Modal.getInstance(document.getElementById("authorModal")).hide();
                await loadAuthors();

            } catch (err) {
                console.error("Lỗi khi gọi API lưu tác giả:", err);
                alert("Không thể lưu tác giả");
            }
        });
    });

    // Lấy danh sách tác giả
    async function loadAuthors() {
        try {
            const res = await fetch("/api/tacgia");
            console.log("Status GET /api/tacgia:", res.status);

            if (!res.ok) {
                const txt = await res.text();
                console.error("Body lỗi:", txt);
                throw new Error("Không thể lấy danh sách tác giả");
            }

            const authors = await res.json();
            allAuthors = authors;
            renderAuthors(authors);

        } catch (err) {
            console.error("Lỗi khi tải danh sách tác giả:", err);
            alert("Không thể lấy danh sách tác giả");
        }
    }

    // Render ra bảng
    function renderAuthors(list) {
        const tbody = document.getElementById("authorTableBody");
        if (!tbody) {
            console.error("Không tìm thấy #authorTableBody");
            return;
        }

        tbody.innerHTML = "";

        list.forEach(tg => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><strong>${tg.MaTG}</strong></td>
                <td>${tg.TenTG}</td>
                <td>${tg.NamSinh || "—"}</td>
                <td>${tg.QueQuan || "—"}</td>
                <td>${tg.NamMat  || "—"}</td>
                <td class="text-center">
                
                    <button class="btn btn-sm btn-outline-warning ms-1" onclick="startEditAuthor(${tg.MaTG})">
                        <i class="bi bi-pencil-square"></i> Sửa
                    </button>
                    <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteAuthor(${tg.MaTG})">
                        <i class="bi bi-trash3"></i> Xóa
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Xem nhanh chi tiết (alert)
    async function viewAuthor(id) {
        try {
            const res = await fetch(`/api/tacgia/${id}`);
            if (!res.ok) return;
            const tg = await res.json();
            alert(
                `Tác giả: ${tg.TenTG}\n` +
                `Năm sinh: ${tg.NamSinh || "—"}\n` +
                `Quê quán: ${tg.QueQuan || "—"}\n` +
                `Năm mất: ${tg.NamMat || "—"}`
            );
        } catch (err) {
            console.error("Lỗi xem chi tiết tác giả:", err);
        }
    }

    // Sửa: lấy dữ liệu + mở modal
    async function startEditAuthor(id) {
        try {
            const res = await fetch(`/api/tacgia/${id}`);
            if (!res.ok) {
                alert("Không lấy được thông tin tác giả");
                return;
            }
            const tg = await res.json();

            isEditing = true;
            editingId = id;

            document.getElementById("authorModalLabel").textContent = "Sửa tác giả";
            document.getElementById("authorCode").value      = tg.MaTG;
            document.getElementById("authorName").value      = tg.TenTG;
            document.getElementById("authorBirth").value     = tg.NamSinh || "";
            document.getElementById("authorDeath").value     = tg.NamMat || "";
            document.getElementById("authorQueQuan").value   = tg.QueQuan || "";

            const modal = new bootstrap.Modal(document.getElementById("authorModal"));
            modal.show();

        } catch (err) {
            console.error("Lỗi load tác giả để sửa:", err);
        }
    }

    // Xóa tác giả
    async function deleteAuthor(id) {
        if (!confirm("Bạn có chắc muốn xóa tác giả này?")) return;

        try {
            const res = await fetch(`/api/tacgia/${id}`, { method: "DELETE" });
            if (!res.ok) {
                const txt = await res.text();
                console.error("Lỗi xóa:", txt);
                alert("Không thể xóa tác giả");
                return;
            }
            await loadAuthors();
        } catch (err) {
            console.error("Lỗi khi xóa tác giả:", err);
        }
    }
    </script>

</body>
</html>
