    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Quản lý Sách - Admin</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
        <script src="../../js/admin-guard.js"></script>

        <style>
            body { background-color: #f5f6f8; overflow-x: hidden; }
            .sidebar { position: fixed; top: 56px; bottom: 0; left: 0; z-index: 1000; padding: 20px 0; background-color: #fff; border-right: 1px solid #dee2e6; width: 240px; overflow-y: auto; }
            .sidebar .nav-link { color: #333; padding: 10px 20px; font-weight: 500; }
            .sidebar .nav-link:hover, .sidebar .nav-link.active { background-color: #0d6efd; color: #fff; }
            .sidebar .nav-link i { margin-right: 10px; }
            .main-content { margin-left: 240px; padding: 20px; margin-top: 56px; }
            .book-cover-thumb { width: 50px; height: 70px; object-fit: cover; border-radius: 4px; border: 1px solid #eee; }
            .card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
            /* Style bổ sung cho Sale */
            .price-old { text-decoration: line-through; color: #6c757d; font-size: 0.85rem; }
            .price-new { color: #dc3545; font-weight: bold; }
        </style>
    </head>
    <body>

        <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
            <div class="container-fluid">
                <a class="navbar-brand ps-3" href="#">Admin Bán Sách</a>
                <div class="d-flex ms-auto pe-3">
                    <div class="dropdown">
                        <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> Chào, Admin!
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item text-danger" href="#" onclick="adminLogout()">Đăng xuất</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <nav class="sidebar">
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link" href="dashboard.html"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                <li class="nav-item"><a class="nav-link active" href="quan_li_sach.html"><i class="bi bi-book"></i> Quản lý Sách</a></li>
                <li class="nav-item"><a class="nav-link" href="quan_li_loai_sach.html"><i class="bi bi-tags"></i> Quản lý Loại sách</a></li>
                <li class="nav-item"><a class="nav-link" href="quan_li_nxb.html"><i class="bi bi-building"></i> Quản lý NXB</a></li>
                <li class="nav-item"><a class="nav-link" href="quan_li_don_hang.html"><i class="bi bi-cart"></i> Quản lý Đơn hàng</a></li>
                <li class="nav-item"><a class="nav-link" href="quan_li_tac_gia.html"><i class="bi bi-people"></i> Quản lý Tác giả</a></li>
                <li class="nav-item"><a class="nav-link" href="quan_li_danh_muc.html"><i class="bi bi-list-task"></i> Quản lý Danh mục</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="h4 mb-0">Quản lý Sách</h2>
                <button class="btn btn-primary" onclick="openAddModal()">
                    <i class="bi bi-plus-lg"></i> Thêm sách mới
                </button>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                                <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm theo tên sách..." onkeyup="filterBooks()">
                            </div>
                        </div>
                        <div class="col-md-3 text-end align-self-center">
                            <span class="text-muted fw-bold" id="totalCount">Tổng: 0 sách</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center" width="50">ID</th>
                                <th width="80">Ảnh</th>
                                <th>Tên sách</th>
                                <th>Giá bán</th>
                                <th class="text-center">Tồn kho</th>
                                <th>Thông tin thêm</th>
                                <th class="text-center" width="180">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="bookTableBody">
                            <tr><td colspan="7" class="text-center py-4">Đang tải dữ liệu...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <nav aria-label="Phân trang danh sách" class="d-flex justify-content-center mt-3">
                <ul class="pagination"></ul>
            </nav>
        </main>

        <div class="modal fade" id="bookModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="bookModalLabel">Thông tin sách</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="bookForm" class="row g-3">
                            <input type="hidden" id="MaSach">
                            <div class="col-md-4 text-center">
                                <div class="mb-3 border rounded p-2 bg-light" style="height: 220px; display:flex; align-items:center; justify-content:center;">
                                    <img id="previewImg" src="https://placehold.co/150x200?text=No+Image" style="max-height: 100%; max-width: 100%;">
                                </div>
                                <input type="file" id="AnhBiaInput" class="form-control form-control-sm" accept="image/*">
                            </div>

                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Tên sách <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="TenSach" required>
                                </div>
                                <div class="row g-2 mb-3">
                                    <div class="col-4">
                                        <label class="form-label">Giá bán gốc</label>
                                        <input type="number" class="form-control" id="GiaBan" required oninput="updateSalePreview()">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label text-danger">Giảm giá (%)</label>
                                        <input type="number" class="form-control" id="PhanTramGiamGia" value="0" oninput="updateSalePreview()">
                                    </div>
                                    <div class="col-4">
                                        <label class="form-label">Tồn kho</label>
                                        <input type="number" class="form-control" id="SoLuongTon" placeholder="0">
                                    </div>
                                </div>
                                <div class="mb-3"><small class="text-primary fw-bold" id="GiaSalePreview"></small></div>
                                
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <label class="form-label">Danh mục</label>
                                        <select class="form-select" id="MaDanhMuc"></select>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Tác giả</label>
                                        <select class="form-select" id="MaTG"></select>
                                    </div>
                                </div>
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <label class="form-label">Nhà xuất bản</label>
                                        <select class="form-select" id="MaNXB"></select>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Loại sách</label>
                                        <select class="form-select" id="MaLoaiSach"></select>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-12">
                                <label class="form-label">Mô tả chi tiết</label>
                                <textarea class="form-control" id="MoTa" rows="3"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="button" class="btn btn-primary" onclick="saveBook()">Lưu lại</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="importModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-sm">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h6 class="modal-title">Nhập hàng vào kho</h6>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="importBookId">
                        <p class="mb-2 fw-bold" id="importBookName">...</p>
                        <label class="form-label small">Số lượng nhập thêm:</label>
                        <input type="number" id="importQty" class="form-control text-center fw-bold text-success" min="1">
                    </div>
                    <div class="modal-footer p-1">
                        <button type="button" class="btn btn-success w-100" onclick="confirmImport()">Xác nhận</button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
        const API_URL = "http://localhost:5001/api";
        let allBooks = [], currentBooks = [], currentPage = 1, rowsPerPage = 10;
        const bookModal = new bootstrap.Modal(document.getElementById('bookModal'));
        const importModal = new bootstrap.Modal(document.getElementById('importModal'));

        document.addEventListener("DOMContentLoaded", async () => {
            await Promise.all([
                loadDropdown('danhmuc', 'MaDanhMuc', 'TenDanhMuc'),
                loadDropdown('tacgia', 'MaTG', 'TenTG'),
                loadDropdown('nxb', 'MaNXB', 'TenNXB'),
                loadDropdown('loaisach', 'MaLoaiSach', 'TenLoaiSach')
            ]);
            loadBooks();
        });

        async function loadBooks() {
            try {
                const res = await fetch(`${API_URL}/sach`);
                const json = await res.json();
                allBooks = Array.isArray(json) ? json : (json.data || []);
                currentBooks = [...allBooks];
                updateView();
            } catch (e) {
                document.getElementById('bookTableBody').innerHTML = `<tr><td colspan="7" class="text-center text-danger">Lỗi kết nối Server!</td></tr>`;
            }
        }

        function updateView() {
            renderTable(currentBooks);
            renderPagination(currentBooks);
            document.getElementById('totalCount').innerText = `Tổng: ${currentBooks.length} sách`;
        }

        function renderTable(list) {
            const tbody = document.getElementById('bookTableBody');
            tbody.innerHTML = "";
            const startIndex = (currentPage - 1) * rowsPerPage;
            const pageItems = list.slice(startIndex, startIndex + rowsPerPage);

            pageItems.forEach(b => {
                const img = (b.AnhBia && b.AnhBia !== 'null') ? b.AnhBia : "https://placehold.co/50x70?text=NoImg";
                const isSale = b.PhanTramGiamGia > 0;
                
                // Hiển thị giá Sale nếu có
                const priceHtml = isSale 
                    ? `<div class="price-old">${parseInt(b.GiaBan).toLocaleString()}đ</div><div class="price-new">${parseInt(b.GiaSale).toLocaleString()}đ <small class="badge bg-danger">-${b.PhanTramGiamGia}%</small></div>`
                    : `<div class="fw-bold text-danger">${parseInt(b.GiaBan).toLocaleString()}đ</div>`;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center text-muted">#${b.MaSach}</td>
                    <td><img src="${img}" class="book-cover-thumb"></td>
                    <td><div class="fw-bold text-primary">${b.TenSach}</div></td>
                    <td>${priceHtml}</td>
                    <td class="text-center"><span class="badge ${b.SoLuongTon < 10 ? 'bg-danger' : 'bg-success'}">${b.SoLuongTon || 0}</span></td>
                    <td><small class="d-block">TG: ${getNameInDropdown('MaTG', b.MaTG)}</small></td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-success me-1" onclick="openImport(${b.MaSach}, '${b.TenSach}')"><i class="bi bi-box-seam"></i></button>
                        <button class="btn btn-sm btn-warning me-1" onclick="openEdit(${b.MaSach})"><i class="bi bi-pencil-square"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBook(${b.MaSach})"><i class="bi bi-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateSalePreview() {
            const gia = document.getElementById('GiaBan').value || 0;
            const phanTram = document.getElementById('PhanTramGiamGia').value || 0;
            if(phanTram > 0) {
                const final = gia * (1 - phanTram / 100);
                document.getElementById('GiaSalePreview').innerText = "Giá sau giảm: " + Math.round(final).toLocaleString() + " đ";
            } else {
                document.getElementById('GiaSalePreview').innerText = "";
            }
        }

        async function openEdit(id) {
            try {
                const res = await fetch(`${API_URL}/sach/${id}`);
                const book = await res.json();
                document.getElementById('MaSach').value = book.MaSach;
                document.getElementById('TenSach').value = book.TenSach;
                document.getElementById('GiaBan').value = book.GiaBan;
                document.getElementById('PhanTramGiamGia').value = book.PhanTramGiamGia || 0;
                document.getElementById('SoLuongTon').value = book.SoLuongTon;
                document.getElementById('MoTa').value = book.MoTa || '';
                ['MaTG', 'MaDanhMuc', 'MaNXB', 'MaLoaiSach'].forEach(key => document.getElementById(key).value = book[key] || "");
                document.getElementById('previewImg').src = book.AnhBia || "https://placehold.co/150x200?text=NoImg";
                updateSalePreview();
                bookModal.show();
            } catch(e) { alert("Lỗi tải sách"); }
        }

        async function saveBook() {
    // 1. Lấy dữ liệu từ form
            const id = document.getElementById('MaSach').value;
            const tenSach = document.getElementById('TenSach').value.trim();
            const giaBan = document.getElementById('GiaBan').value;
            const phanTram = document.getElementById('PhanTramGiamGia').value || 0;
            const tonKho = document.getElementById('SoLuongTon').value || 0;
            const moTa = document.getElementById('MoTa').value;
            
            // Lấy giá trị các Dropdown
            const maTG = document.getElementById('MaTG').value;
            const maDM = document.getElementById('MaDanhMuc').value;
            const maNXB = document.getElementById('MaNXB').value;
            const maLoai = document.getElementById('MaLoaiSach').value;

            // 2. VALIDATE DỮ LIỆU (Quan trọng để tránh lỗi 500)
            if (!tenSach) { alert("Vui lòng nhập tên sách!"); return; }
            if (!giaBan) { alert("Vui lòng nhập giá bán!"); return; }
            
            // Kiểm tra xem đã chọn các dropdown chưa, nếu chưa chọn value sẽ là rỗng ""
            if (!maTG) { alert("Vui lòng chọn Tác giả!"); return; }
            if (!maDM) { alert("Vui lòng chọn Danh mục!"); return; }
            if (!maNXB) { alert("Vui lòng chọn Nhà xuất bản!"); return; }
            if (!maLoai) { alert("Vui lòng chọn Loại sách!"); return; }

            // 3. Đóng gói FormData
            const formData = new FormData();
            formData.append('TenSach', tenSach);
            formData.append('GiaBan', giaBan);
            formData.append('PhanTramGiamGia', phanTram);
            formData.append('SoLuongTon', tonKho);
            formData.append('MoTa', moTa);
            
            formData.append('MaTG', maTG);
            formData.append('MaDanhMuc', maDM);
            formData.append('MaNXB', maNXB);
            formData.append('MaLoaiSach', maLoai);

            const fileInput = document.getElementById('AnhBiaInput');
            if (fileInput.files[0]) {
                formData.append('AnhBia', fileInput.files[0]);
            }

            // 4. Gửi Request
            const url = id ?(`${API_URL}/sach/${id}`) : (`${API_URL}/sach`);
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, { method, body: formData });
                
                // Đọc phản hồi từ server bất kể thành công hay thất bại
                const responseText = await res.text(); 

                if (res.ok) {
                    alert("Lưu thành công!");
                    bookModal.hide();
                    loadBooks();
                } else {
                    // Hiển thị lỗi thực sự từ Server (thay vì chỉ báo chung chung)
                    console.error("Server Error Detail:", responseText);
                    
                    // Cố gắng parse JSON nếu server trả về JSON lỗi
                    try {
                        const errJson = JSON.parse(responseText);
                        alert("Lỗi: " + (errJson.message || errJson.error || responseText));
                    } catch {
                        alert("Lỗi Server (500): " + responseText.substring(0, 100) + "...");
                    }
                }
            } catch (e) {
                console.error(e);
                alert("Lỗi kết nối đến Server (Network Error)");
            }
        }

        // --- CÁC HÀM CŨ GIỮ NGUYÊN ---
        function renderPagination(list) {
            const paginationUl = document.querySelector('.pagination');
            paginationUl.innerHTML = "";
            const totalPages = Math.ceil(list.length / rowsPerPage);
            if (totalPages <= 1) return;
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="currentPage=${i};updateView()">${i}</a>`;
                paginationUl.appendChild(li);
            }
        }

        function filterBooks() {
            const key = document.getElementById('searchInput').value.toLowerCase();
            currentBooks = allBooks.filter(b => b.TenSach.toLowerCase().includes(key));
            currentPage = 1;
            updateView();
        }

        function openAddModal() {
            document.getElementById('bookForm').reset();
            document.getElementById('MaSach').value = '';
            document.getElementById('previewImg').src = "https://placehold.co/150x200?text=Upload";
            updateSalePreview();
            bookModal.show();
        }

        async function deleteBook(id) {
            if(!confirm("Xóa sách này?")) return;
            await fetch(`${API_URL}/sach/${id}`, { method: 'DELETE' });
            loadBooks();
        }

        function openImport(id, name) {
            document.getElementById('importBookId').value = id;
            document.getElementById('importBookName').innerText = name;
            importModal.show();
        }

        async function confirmImport() {
            const id = document.getElementById('importBookId').value;
            const qty = document.getElementById('importQty').value;
            await fetch(`${API_URL}/sach/${id}/nhap-hang`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ soLuong: parseInt(qty) })
            });
            importModal.hide();
            loadBooks();
        }

        async function loadDropdown(endpoint, idElem, nameField) {
            const res = await fetch(`${API_URL}/${endpoint}`);
            const data = await res.json();
            const list = Array.isArray(data) ? data : data.data;
            const select = document.getElementById(idElem);
            select.innerHTML = '<option value="">-- Chọn --</option>';
            list.forEach(item => select.innerHTML += `<option value="${Object.values(item)[0]}">${item[nameField]}</option>`);
        }

        function getNameInDropdown(elemId, value) {
            const select = document.getElementById(elemId);
            if(!select) return "-";
            const option = select.querySelector(`option[value="${value}"]`);
            return option ? option.text : "-";
        }

        document.getElementById('AnhBiaInput').onchange = evt => {
            const [file] = evt.target.files;
            if (file) document.getElementById('previewImg').src = URL.createObjectURL(file);
        };
    </script>
    </body>
    </html>
