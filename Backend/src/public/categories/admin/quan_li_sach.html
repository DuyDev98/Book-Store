<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý Sách - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <script src="../../js/admin-guard.js"></script>

    <style>
        body {
            background-color: #f5f6f8;
            overflow-x: hidden;
        }
        /* Sidebar cố định */
        .sidebar {
            position: fixed; top: 56px; bottom: 0; left: 0;
            z-index: 1000; padding: 20px 0;
            background-color: #fff; border-right: 1px solid #dee2e6;
            width: 240px; overflow-y: auto;
        }
        .sidebar .nav-link { color: #333; padding: 10px 20px; font-weight: 500; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: #0d6efd; color: #fff;
        }
        .sidebar .nav-link i { margin-right: 10px; }
        
        .main-content { margin-left: 240px; padding: 20px; margin-top: 56px; }
        
        /* Style cho bảng sách */
        .book-cover-thumb {
            width: 50px; height: 70px; object-fit: cover;
            border-radius: 4px; border: 1px solid #eee;
        }
        .card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand ps-3" href="#">Admin Bán Sách</a>
            <div class="d-flex ms-auto pe-3">
                <div class="dropdown">
                    <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle"></i> Chào, Admin!
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                     
                        <li><a class="dropdown-item text-danger" href="#" onclick="adminLogout()">Đăng xuất</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <nav class="sidebar">
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link" href="dashboard.html"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
            <li class="nav-item"><a class="nav-link active" href="quan_li_sach.html"><i class="bi bi-book"></i> Quản lý Sách</a></li>
            <li class="nav-item"><a class="nav-link" href="quan_li_loai_sach.html"><i class="bi bi-tags"></i> Quản lý Loại sách</a></li>
            <li class="nav-item"><a class="nav-link" href="quan_li_nxb.html"><i class="bi bi-building"></i> Quản lý NXB</a></li>
            <li class="nav-item"><a class="nav-link" href="quan_li_don_hang.html"><i class="bi bi-cart"></i> Quản lý Đơn hàng</a></li>
            <li class="nav-item"><a class="nav-link" href="quan_li_binh_luan.html"><i class="bi bi-chat-dots"></i> Quản lý Bình luận</a></li>
            <li class="nav-item"><a class="nav-link" href="quan_li_tac_gia.html"><i class="bi bi-people"></i> Quản lý Tác giả</a></li>
            <li class="nav-item"><a class="nav-link" href="quan_li_danh_muc.html"><i class="bi bi-list-task"></i> Quản lý Danh mục</a></li>
        </ul>
    </nav>

    <main class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="h4 mb-0">Quản lý Sách</h2>
            <button class="btn btn-primary" onclick="openAddModal()">
                <i class="bi bi-plus-lg"></i> Thêm sách mới
            </button>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                            <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm theo tên sách..." onkeyup="filterBooks()">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterCategory" onchange="filterBooks()">
                            <option value="">Tất cả danh mục</option>
                            </select>
                    </div>
                    <div class="col-md-3 text-end align-self-center">
                        <span class="text-muted fw-bold" id="totalCount">Tổng: 0 sách</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center" width="50">ID</th>
                            <th width="80">Ảnh</th>
                            <th>Tên sách</th>
                            <th>Giá bán</th>
                            <th class="text-center">Tồn kho</th>
                            <th>Thông tin thêm</th>
                            <th class="text-center" width="180">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="bookTableBody">
                        <tr><td colspan="7" class="text-center py-4">Đang tải dữ liệu...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div class="modal fade" id="bookModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bookModalLabel">Thông tin sách</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bookForm" class="row g-3">
                        <input type="hidden" id="MaSach"> <div class="col-md-4 text-center">
                            <div class="mb-3 border rounded p-2 bg-light" style="height: 220px; display:flex; align-items:center; justify-content:center;">
                                <img id="previewImg" src="https://placehold.co/150x200?text=No+Image" style="max-height: 100%; max-width: 100%;">
                            </div>
                            <input type="file" id="AnhBiaInput" class="form-control form-control-sm" accept="image/*">
                            <div class="form-text text-start">Chọn ảnh bìa (jpg, png)</div>
                        </div>

                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label">Tên sách <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="TenSach" required>
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="form-label">Giá bán</label>
                                    <input type="number" class="form-control" id="GiaBan" required>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Tồn kho (Ban đầu)</label>
                                    <input type="number" class="form-control" id="SoLuongTon" placeholder="0">
                                </div>
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="form-label">Danh mục</label>
                                    <select class="form-select" id="MaDanhMuc"></select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Tác giả</label>
                                    <select class="form-select" id="MaTG"></select>
                                </div>
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="form-label">Nhà xuất bản</label>
                                    <select class="form-select" id="MaNXB"></select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Loại sách</label>
                                    <select class="form-select" id="MaLoaiSach"></select>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-12">
                            <label class="form-label">Mô tả chi tiết</label>
                            <textarea class="form-control" id="MoTa" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveBook()">Lưu lại</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h6 class="modal-title">Nhập hàng vào kho</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="importBookId">
                    <p class="mb-2 fw-bold" id="importBookName">...</p>
                    <label class="form-label small">Số lượng nhập thêm:</label>
                    <input type="number" id="importQty" class="form-control text-center fw-bold text-success" min="1">
                </div>
                <div class="modal-footer p-1">
                    <button type="button" class="btn btn-success w-100" onclick="confirmImport()">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = "http://localhost:5001/api";
        let allBooks = [];
        const bookModal = new bootstrap.Modal(document.getElementById('bookModal'));
        const importModal = new bootstrap.Modal(document.getElementById('importModal'));

        // --- 1. KHỞI TẠO & LOAD DỮ LIỆU ---
        document.addEventListener("DOMContentLoaded", async () => {
            await Promise.all([
                loadDropdown('danhmuc', 'MaDanhMuc', 'TenDanhMuc'),
                loadDropdown('tacgia', 'MaTG', 'TenTG'),
                loadDropdown('nxb', 'MaNXB', 'TenNXB'),
                loadDropdown('loaisach', 'MaLoaiSach', 'TenLoaiSach')
            ]);
            loadBooks();
        });

        async function loadBooks() {
            try {
                const res = await fetch(`${API_URL}/sach`);
                const json = await res.json();
                // Xử lý dữ liệu trả về (có thể là mảng hoặc object {data: []})
                allBooks = Array.isArray(json) ? json : (json.data || []);
                renderTable(allBooks);
            } catch (e) {
                console.error(e);
                document.getElementById('bookTableBody').innerHTML = `<tr><td colspan="7" class="text-center text-danger">Lỗi kết nối Server!</td></tr>`;
            }
        }

        // --- 2. RENDER BẢNG ---
        function renderTable(list) {
            const tbody = document.getElementById('bookTableBody');
            document.getElementById('totalCount').innerText = `Tổng: ${list.length} sách`;
            tbody.innerHTML = "";

            if (list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center">Không có dữ liệu</td></tr>`;
                return;
            }

            list.forEach(b => {
                const img = (b.AnhBia && b.AnhBia !== 'null') ? b.AnhBia : "https://placehold.co/50x70?text=NoImg";
                const price = b.GiaBan ? parseInt(b.GiaBan).toLocaleString() + 'đ' : '0đ';
                const stockClass = (b.SoLuongTon < 10) ? 'bg-danger' : 'bg-success';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center text-muted">#${b.MaSach}</td>
                    <td><img src="${img}" class="book-cover-thumb"></td>
                    <td>
                        <div class="fw-bold text-primary">${b.TenSach}</div>
                        <small class="text-muted">Năm XB: ${b.NamXuatBan || '-'}</small>
                    </td>
                    <td class="fw-bold text-danger">${price}</td>
                    <td class="text-center">
                        <span class="badge ${stockClass}">${b.SoLuongTon || 0}</span>
                    </td>
                    <td>
                        <small class="d-block">TG: ${getNameInDropdown('MaTG', b.MaTG)}</small>
                        <small class="d-block">DM: ${getNameInDropdown('MaDanhMuc', b.MaDanhMuc)}</small>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-success me-1" title="Nhập hàng" onclick="openImport(${b.MaSach}, '${b.TenSach}')">
                            <i class="bi bi-box-seam"></i>
                        </button>
                        <button class="btn btn-sm btn-warning me-1" title="Sửa" onclick="openEdit(${b.MaSach})">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" title="Xóa" onclick="deleteBook(${b.MaSach})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 3. THÊM / SỬA SÁCH (DÙNG FORMDATA ĐỂ UPLOAD ẢNH) ---
        function openAddModal() {
            document.getElementById('bookForm').reset();
            document.getElementById('MaSach').value = ''; // Rỗng là thêm mới
            document.getElementById('bookModalLabel').innerText = "Thêm Sách Mới";
            document.getElementById('previewImg').src = "https://placehold.co/150x200?text=Upload";
            document.getElementById('SoLuongTon').disabled = false; // Cho phép nhập tồn kho khi tạo mới
            bookModal.show();
        }

        async function openEdit(id) {
            try {
                const res = await fetch(`${API_URL}/sach/${id}`);
                const data = await res.json();
                // Backend của bạn trả về object trực tiếp (theo code controller bạn gửi)
                const book = data; 

                document.getElementById('MaSach').value = book.MaSach;
                document.getElementById('TenSach').value = book.TenSach;
                document.getElementById('GiaBan').value = book.GiaBan;
                document.getElementById('SoLuongTon').value = book.SoLuongTon;
                document.getElementById('SoLuongTon').disabled = true; // Không sửa tồn kho ở đây, phải dùng Nhập hàng
                document.getElementById('MoTa').value = book.MoTa || '';
                
                // Set dropdowns
                ['MaTG', 'MaDanhMuc', 'MaNXB', 'MaLoaiSach'].forEach(key => {
                    document.getElementById(key).value = book[key] || "";
                });

                document.getElementById('previewImg').src = book.AnhBia || "https://placehold.co/150x200?text=NoImg";
                document.getElementById('bookModalLabel').innerText = "Cập nhật sách: #" + id;
                bookModal.show();
            } catch(e) { alert("Lỗi tải thông tin sách"); }
        }

        async function saveBook() {
            const id = document.getElementById('MaSach').value;
            const isEdit = !!id;
            
            // Dùng FormData để gửi cả Text và File
            const formData = new FormData();
            formData.append('TenSach', document.getElementById('TenSach').value);
            formData.append('GiaBan', document.getElementById('GiaBan').value);
            formData.append('SoLuongTon', document.getElementById('SoLuongTon').value);
            formData.append('MoTa', document.getElementById('MoTa').value);
            
            // Append dropdowns
            ['MaTG', 'MaDanhMuc', 'MaNXB', 'MaLoaiSach'].forEach(k => {
                formData.append(k, document.getElementById(k).value);
            });

            // Append File ảnh nếu có chọn
            const fileInput = document.getElementById('AnhBiaInput');
            if (fileInput.files[0]) {
                formData.append('AnhBia', fileInput.files[0]);
            }

            const url = isEdit ?(`${API_URL}/sach/${id}`) : (`${API_URL}/sach`);
            const method = isEdit ? 'PUT' : 'POST';

            try {
                // Fetch gửi FormData (Không cần set Content-Type, trình duyệt tự làm)
                const res = await fetch(url, {
                    method: method,
                    body: formData
                });

                if (res.ok) {
                    alert("Lưu thành công!");
                    bookModal.hide();
                    loadBooks();
                } else {
                    const err = await res.json();
                    alert("Lỗi: " + err.message);
                }
            } catch (e) { alert("Lỗi kết nối server"); }
        }

        // --- 4. NHẬP HÀNG ---
        function openImport(id, name) {
            document.getElementById('importBookId').value = id;
            document.getElementById('importBookName').innerText = name;
            document.getElementById('importQty').value = "";
            importModal.show();
        }

        async function confirmImport() {
            const id = document.getElementById('importBookId').value;
            const qty = document.getElementById('importQty').value;
            if(!qty || qty < 1) return alert("Nhập số lượng hợp lệ!");

            try {
                const res = await fetch(`${API_URL}/sach/${id}/nhap-hang`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ soLuong: parseInt(qty) })
                });
                if(res.ok) {
                    alert("Nhập hàng thành công!");
                    importModal.hide();
                    loadBooks();
                } else { alert("Lỗi nhập hàng"); }
            } catch(e) { alert("Lỗi kết nối"); }
        }

        // --- 5. XÓA SÁCH ---
        async function deleteBook(id) {
            if(!confirm("Bạn có chắc chắn xóa sách này?")) return;
            try {
                const res = await fetch(`${API_URL}/sach/${id}`, { method: 'DELETE' });
                if(res.ok) loadBooks();
                else alert("Không thể xóa sách này");
            } catch(e) { alert("Lỗi server"); }
        }

        // --- TIỆN ÍCH ---
        // Xem trước ảnh khi chọn file
        document.getElementById('AnhBiaInput').onchange = evt => {
            const [file] = evt.target.files;
            if (file) document.getElementById('previewImg').src = URL.createObjectURL(file);
        };

        // Lọc sách client-side
        function filterBooks() {
            const key = document.getElementById('searchInput').value.toLowerCase();
            const cat = document.getElementById('filterCategory').value;
            
            const filtered = allBooks.filter(b => {
                const matchName = b.TenSach.toLowerCase().includes(key);
                const matchCat = cat === "" || b.MaDanhMuc == cat;
                return matchName && matchCat;
            });
            renderTable(filtered);
        }

        // Helper tải dropdown
        async function loadDropdown(endpoint, idElem, nameField) {
            try {
                const res = await fetch(`${API_URL}/${endpoint}`);
                const data = await res.json();
                const list = Array.isArray(data) ? data : data.data;
                const select = document.getElementById(idElem);
                if (!select) return; // Nếu form không có select này (ví dụ ở thanh lọc)
                
                // Nếu là thanh lọc (filterCategory) thì giữ nguyên option "Tất cả"
                if(idElem === 'filterCategory') {
                    select.innerHTML = '<option value="">Tất cả danh mục</option>';
                } else {
                    select.innerHTML = '<option value="">-- Chọn --</option>';
                }

                // Mapping ID field (MaTG, MaNXB...)
                const idField = list.length > 0 ? Object.keys(list[0])[0] : 'id'; 

                list.forEach(item => {
                    select.innerHTML += `<option value="${item[idField]}">${item[nameField]}</option>`;
                });
            } catch(e) {}
        }

        // Helper lấy tên từ dropdown để hiển thị lên bảng
        function getNameInDropdown(elemId, value) {
            const select = document.getElementById(elemId);
            if(!select) return "-";
            const option = select.querySelector(`option[value="${value}"]`);
            return option ? option.text : "-";
        }
    </script>
</body>
</html>