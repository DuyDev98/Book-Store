<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Quản lý Sách</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <style>
      body { font-size: 0.9rem; background-color: #f8f9fa; }
      .sidebar { position: fixed; top: 0; bottom: 0; left: 0; z-index: 100; padding: 48px 0 0; box-shadow: inset -1px 0 0 rgba(0, 0, 0, 0.1); background-color: #fff; }
      .sidebar-sticky { position: relative; top: 0; height: calc(100vh - 48px); padding-top: 0.5rem; overflow-x: hidden; overflow-y: auto; }
      .sidebar .nav-link { font-weight: 500; color: #333; padding: 10px 20px; display: flex; align-items: center; gap: 10px; }
      .sidebar .nav-link:hover { color: #0d6efd; background-color: #f1f1f1; }
      .sidebar .nav-link.active { color: #0d6efd; background-color: #e9ecef; border-right: 3px solid #0d6efd; }
      .main-content { margin-top: 50px; padding-bottom: 20px; }
      .table img.book-cover { width: 50px; height: 70px; object-fit: cover; border-radius: 4px; border: 1px solid #dee2e6; }
      .search-container { position: relative; }
      .search-container i { position: absolute; top: 50%; left: 15px; transform: translateY(-50%); color: #6c757d; }
      .search-container input { padding-left: 40px; border-radius: 20px; }
    </style>
  </head>
  <body>
    <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
      <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">Admin Bán Sách</a>
      <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
        <span class="navbar-toggler-icon"></span>
      </button>
    </header>

    <div class="container-fluid">
      <div class="row">
        <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
          <div class="sidebar-sticky pt-3">
            <ul class="nav flex-column">
              <li class="nav-item"><a class="nav-link" href="dashboard.html"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
              <li class="nav-item"><a class="nav-link active" href="quan_li_sach.html"><i class="bi bi-book"></i> Quản lý Sách</a></li>
              <li class="nav-item"><a class="nav-link" href="quan_li_tac_gia.html"><i class="bi bi-people"></i> Quản lý Tác giả</a></li>
              <li class="nav-item"><a class="nav-link" href="quan_li_nxb.html"><i class="bi bi-building"></i> Quản lý NXB</a></li>
              <li class="nav-item"><a class="nav-link" href="quan_li_danh_muc.html"><i class="bi bi-tags"></i> Quản lý Danh mục</a></li>
              <li class="nav-item"><a class="nav-link" href="quan_li_don_hang.html"><i class="bi bi-cart4"></i> Quản lý Đơn hàng</a></li>
              <li class="nav-item"><a class="nav-link" href="quan_li_khach_hang.html"><i class="bi bi-person-lines-fill"></i> Quản lý Khách hàng</a></li> 
              <li class="nav-item"><a class="nav-link" href="quan_li_binh_luan.html"><i class="bi bi-chat-dots"></i> Quản lý Bình luận</a></li>
              <li class="nav-item"><a class="nav-link" href="quan_li_phan_hoi.html"><i class="bi bi-envelope"></i> Quản lý Phản hồi</a></li>
              <li class="nav-item"><a class="nav-link" href="quan_li_loai_sach.html"><i class="bi bi-tags"></i> Quản lý Loại sách</a></li>
              
              </ul>
          </div>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
          <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">Quản lý Sách</h1>
            <button type="button" class="btn btn-primary" id="openAddBookBtn">
                <i class="bi bi-plus-lg"></i> Thêm sách mới
            </button>
          </div>

          <div class="row mb-4">
            <div class="col-md-5">
              <div class="search-container">
                <i class="bi bi-search"></i>
                <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm theo tên sách..." onkeyup="filterBooks()" />
              </div>
            </div>
            <div class="col-md-7 text-end">
              <span class="text-muted fst-italic" id="totalCount">Đang tải...</span>
            </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th class="text-center" width="5%">ID</th>
                      <th width="10%">Ảnh</th>
                      <th width="25%">Tên sách</th>
                      <th width="10%">Giá bán</th>
                      <th width="10%">Tồn kho</th>
                      <th width="20%">Thông tin</th>
                      <th class="text-center" width="20%">Thao tác</th>
                    </tr>
                  </thead>
                  <tbody id="bookTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <div class="modal fade" id="bookModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="bookModalLabel">Thông tin sách</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="bookForm" class="row g-3">
              <input type="hidden" id="MaSach" />
              <div class="col-md-4 text-center">
                <label class="form-label fw-bold">Ảnh bìa</label>
                <div class="mb-2">
                  <img id="AnhBiaPreview" src="https://placehold.co/150x200?text=Image" class="img-thumbnail" style="height: 150px; width: 100%; object-fit: contain" />
                </div>
                <input type="file" id="AnhBiaInput" accept="image/*" class="d-none" />
                <label for="AnhBiaInput" class="btn btn-outline-primary btn-sm w-100"><i class="bi bi-upload me-1"></i> Chọn ảnh</label>
                <small id="fileNameDisplay" class="text-muted d-block mt-1 text-truncate">Chưa chọn tệp</small>
              </div>
              <div class="col-md-8">
                <div class="row g-2">
                  <div class="col-12">
                    <label class="form-label">Tên sách <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="TenSach" required />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Giá bán</label>
                    <input type="number" class="form-control" id="GiaBan" />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Tồn kho (Ban đầu)</label>
                    <input type="number" class="form-control" id="SoLuongTon" placeholder="0" />
                  </div>
                  <div class="col-md-6"><label class="form-label">Tác giả</label><select class="form-select" id="MaTG"></select></div>
                  <div class="col-md-6"><label class="form-label">NXB</label><select class="form-select" id="MaNXB"></select></div>
                  <div class="col-md-6"><label class="form-label">Danh mục</label><select class="form-select" id="MaDanhMuc"></select></div>
                  <div class="col-md-6"><label class="form-label">Loại</label><select class="form-select" id="MaLoaiSach"></select></div>
                </div>
              </div>
              <div class="col-md-6"><label class="form-label">Năm XB</label><input type="number" class="form-control" id="NamXuatBan" /></div>
              <div class="col-md-6"><label class="form-label">Tái bản</label><input type="number" class="form-control" id="LanTaiBan" /></div>
              <div class="col-12"><label class="form-label">Mô tả</label><textarea class="form-control" id="MoTa" rows="2"></textarea></div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
            <button type="button" class="btn btn-primary" id="saveBookBtn">Lưu lại</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-success text-white">
              <h5 class="modal-title"><i class="bi bi-box-seam"></i> Nhập Hàng Vào Kho</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="importBookId" />
              <div class="mb-3">
                <label class="form-label fw-bold">Tên sách:</label>
                <input type="text" class="form-control-plaintext" id="importBookName" readonly />
              </div>
              <div class="mb-3">
                <label class="form-label fw-bold">Số lượng nhập thêm:</label>
                <input type="number" class="form-control form-control-lg text-center fw-bold text-success" id="importQuantity" placeholder="0" min="1" />
                <div class="form-text">Số lượng này sẽ được CỘNG thêm vào kho hiện tại.</div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
              <button type="button" class="btn btn-success" onclick="confirmImport()">Xác nhận nhập</button>
            </div>
          </div>
        </div>
      </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let allBooks = [];
      let isEditing = false;
      let editingId = null;
      const myModal = new bootstrap.Modal(document.getElementById("bookModal"));
      const importModal = new bootstrap.Modal(document.getElementById("importModal"));

      document.addEventListener("DOMContentLoaded", () => {
        loadDropdown("/api/tacgia", "MaTG", "MaTG", "TenTG");
        loadDropdown("/api/loaisach", "MaLoaiSach", "MaLoaiSach", "TenLoaiSach");
        loadDropdown("/api/nxb", "MaNXB", "MaNXB", "TenNXB");
        loadDropdown("/api/danhmuc", "MaDanhMuc", "MaDanhMuc", "TenDanhMuc");
        loadBooks();
      });

      // 1. Tải danh sách
      async function loadBooks() {
        const tbody = document.getElementById("bookTableBody");
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Đang tải...</td></tr>';
        try {
          const res = await fetch("/api/sach");
          const data = await res.json();
          let books = [];
          if (Array.isArray(data)) books = data;
          else if (data.data && Array.isArray(data.data)) books = data.data;

          allBooks = books;
          renderTable(allBooks);
        } catch (err) {
          tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Lỗi kết nối</td></tr>`;
        }
      }

      function renderTable(list) {
        const tbody = document.getElementById("bookTableBody");
        document.getElementById("totalCount").innerText = `Tổng số: ${list.length} quyển`;
        tbody.innerHTML = "";

        if (list.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center">Không có sách nào</td></tr>`;
            return;
        }

        list.forEach((b) => {
          let imgSrc = (b.AnhBia && b.AnhBia !== 'null') ? b.AnhBia : "https://placehold.co/50x75?text=No+Img";
          const gia = b.GiaBan ? parseInt(b.GiaBan).toLocaleString("vi-VN") + " đ" : "0 đ";
          const tonKho = b.SoLuongTon || 0;
          const badgeClass = tonKho < 10 ? "bg-danger" : "bg-success";
          
          tbody.innerHTML += `
            <tr>
                <td class="text-center text-muted">#${b.MaSach}</td>
                <td><img src="${imgSrc}" class="book-cover"></td>
                <td class="fw-bold text-primary">${b.TenSach}</td>
                <td class="text-danger fw-bold">${gia}</td>
                <td class="text-center"><span class="badge ${badgeClass} rounded-pill">${tonKho}</span></td>
                <td><small class="text-muted d-block">TG: ${b.TenTG || "-"}</small></td>
                <td class="text-center">
                    <button class="btn btn-sm btn-success me-1" title="Nhập hàng" 
                        onclick="openImportModal(${b.MaSach}, '${b.TenSach ? b.TenSach.replace(/'/g, "\\'") : ""}')">
                        <i class="bi bi-box-seam"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="prepareEdit(${b.MaSach})"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteBook(${b.MaSach})"><i class="bi bi-trash"></i></button>
                </td>
            </tr>`;
        });
      }

      // 2. Chuẩn bị Edit
      async function prepareEdit(id) {
        try {
          const res = await fetch(`/api/sach/${id}`);
          const data = await res.json();
          const b = data.data || data; 

          if (!b || !b.MaSach) {
              alert("Không lấy được thông tin sách!");
              return;
          }

          isEditing = true;
          editingId = id;
          document.getElementById("bookModalLabel").innerText = "Cập nhật sách";

          document.getElementById("MaSach").value = b.MaSach;
          document.getElementById("TenSach").value = b.TenSach;
          document.getElementById("GiaBan").value = b.GiaBan;
          document.getElementById("SoLuongTon").value = b.SoLuongTon;
          document.getElementById("SoLuongTon").disabled = true; 
          document.getElementById("NamXuatBan").value = b.NamXuatBan;
          document.getElementById("LanTaiBan").value = b.LanTaiBan;
          document.getElementById("MoTa").value = b.MoTa;

          ["MaTG", "MaNXB", "MaDanhMuc", "MaLoaiSach"].forEach(k => {
             if(document.getElementById(k)) document.getElementById(k).value = b[k] || "";
          });

          document.getElementById("AnhBiaPreview").src = b.AnhBia || "https://placehold.co/150x200?text=Img";
          myModal.show();
        } catch (e) {
          alert("Lỗi tải sách: " + e.message);
        }
      }

      document.getElementById("openAddBookBtn").addEventListener("click", () => {
          isEditing = false;
          document.getElementById("bookForm").reset();
          document.getElementById("bookModalLabel").innerText = "Thêm sách mới";
          document.getElementById("SoLuongTon").disabled = false;
          document.getElementById("AnhBiaPreview").src = "https://placehold.co/150x200?text=Img";
          myModal.show();
      });

      document.getElementById("saveBookBtn").addEventListener("click", async () => {
          const formData = new FormData();
          ["TenSach", "GiaBan", "SoLuongTon", "NamXuatBan", "LanTaiBan", "MoTa", "MaTG", "MaNXB", "MaDanhMuc", "MaLoaiSach"].forEach(id => {
              const val = document.getElementById(id).value;
              formData.append(id, val);
          });

          const fileInput = document.getElementById("AnhBiaInput");
          if (fileInput.files.length > 0) formData.append("AnhBia", fileInput.files[0]);

          const url = isEditing ? `/api/sach/${editingId}` : "/api/sach";
          const method = isEditing ? "PUT" : "POST";

          try {
              const res = await fetch(url, { method: method, body: formData });
              if (res.ok) {
                  alert("Thành công!");
                  myModal.hide();
                  loadBooks();
              } else {
                  const err = await res.json();
                  alert("Lỗi: " + err.message);
              }
          } catch (e) { alert("Lỗi kết nối!"); }
      });

      // --- LOGIC NHẬP HÀNG (QUAN TRỌNG) ---
      function openImportModal(id, name) {
        document.getElementById("importBookId").value = id;
        document.getElementById("importBookName").value = name;
        document.getElementById("importQuantity").value = "";
        importModal.show();
        setTimeout(() => document.getElementById("importQuantity").focus(), 500);
      }

      async function confirmImport() {
        const id = document.getElementById("importBookId").value;
        const qty = document.getElementById("importQuantity").value;

        if (!qty || qty <= 0) {
          alert("Vui lòng nhập số lượng > 0");
          return;
        }

        try {
          // Gọi API Nhập hàng
          const res = await fetch(`/api/sach/${id}/nhap-hang`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ soLuong: parseInt(qty) }),
          });
          if (res.ok) {
            alert("Nhập hàng thành công!");
            importModal.hide();
            loadBooks(); // Tải lại bảng để thấy số tồn kho tăng lên
          } else {
            const err = await res.json();
            alert("Lỗi: " + err.message);
          }
        } catch (e) {
          alert("Lỗi kết nối server!");
        }
      }

      async function deleteBook(id) {
          if (!confirm("Chắc chắn xóa?")) return;
          try {
              const res = await fetch(`/api/sach/${id}`, { method: "DELETE" });
              if (res.ok) loadBooks();
              else alert("Không thể xóa!");
          } catch (e) { alert("Lỗi server!"); }
      }

      function filterBooks() {
          const key = document.getElementById("searchInput").value.toLowerCase();
          renderTable(allBooks.filter(b => b.TenSach.toLowerCase().includes(key)));
      }
      async function loadDropdown(url, elId, valKey, txtKey) {
          try {
             const res = await fetch(url);
             const data = await res.json();
             const list = Array.isArray(data) ? data : data.data || [];
             const sel = document.getElementById(elId);
             if(sel) {
                 sel.innerHTML = '<option value="">-- Chọn --</option>';
                 list.forEach(i => sel.innerHTML += `<option value="${i[valKey]}">${i[txtKey]}</option>`);
             }
          } catch(e) {}
      }
      document.getElementById("AnhBiaInput").addEventListener("change", (e) => {
          if(e.target.files[0]) document.getElementById("AnhBiaPreview").src = URL.createObjectURL(e.target.files[0]);
      });
    </script>
  </body>
</html>