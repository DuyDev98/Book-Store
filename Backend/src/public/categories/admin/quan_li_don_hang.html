<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Bán Sách</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <script src="../../js/admin-guard.js"></script>

    <style>
        body {
            padding-top: 57px;
            background-color: #f5f6f8;
            margin-left: 240px;
            overflow-x: hidden; /* Ẩn thanh cuộn ngang của toàn trang */
        }

        .sidebar {
            position: fixed;
            top: 56px;
            bottom: 0;
            left: 0;
            z-index: 1000;
            padding: 20px 0;
            overflow-x: hidden;
            overflow-y: auto;
            background-color: #ffffff;
            border-right: 1px solid #dee2e6;
        }

        .sidebar .nav-link {
            color: #333;
            padding: 10px 20px;
            font-weight: 500;
        }

        .sidebar .nav-link i {
            margin-right: 8px;
        }

        .sidebar .nav-link.active {
            background-color: #0d6efd;
            color: #fff;
        }

        .sidebar .nav-link.active i {
            color: #fff;
        }

        .main-content {
            
            padding: 20px;
        }

        .card {
            border-radius: 0.5rem;
            border: 1px solid #e3e6ea;
            box-shadow: 0 2px 4px rgba(15, 34, 58, 0.05);
        }

        .table thead th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.04em;
        }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Admin Bán Sách</a>

            <div class="d-flex ms-auto">
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i> Chào, Admin!
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item text-danger" href="#" onclick="adminLogout()">Đăng xuất</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <nav class="col-md-3 col-lg-2 d-md-block sidebar" style="width: 240px">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link" href="dashboard.html"
                ><i class="bi bi-house-door"></i> Dashboard</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_sach.html"
                ><i class="bi bi-book"></i> Quản lý Sách</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_loai_sach.html"
                ><i class="bi bi-tags"></i> Quản lý Loại sách</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_nxb.html"
                ><i class="bi bi-building"></i> Quản lý NXB</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="quan_li_don_hang.html"
                ><i class="bi bi-cart"></i> Quản lý Đơn hàng</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_hoi_vien.html"
                ><i class="bi bi-people"></i> Quản lý Hội viên</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_binh_luan.html"
                ><i class="bi bi-chat-dots"></i> Quản lý Bình luận</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_phan_hoi.html"
                ><i class="bi bi-envelope"></i> Quản lý Phản hồi</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_tac_gia.html"
                ><i class="bi bi-people"></i> Quản lý tác giả</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_danh_muc.html"
                ><i class="bi bi-list-task"></i> Quản lý Danh mục</a
              >
            </li>
          </ul>
        </nav>

            <nav class="col-md-3 col-lg-2 d-md-block sidebar" style="width: 240px;">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="bi bi-house-door"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_sach.html">
                            <i class="bi bi-book"></i> Quản lý Sách
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_loai_sach.html">
                            <i class="bi bi-tags"></i> Quản lý Loại sách
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_nxb.html">
                            <i class="bi bi-building"></i> Quản lý NXB
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="quan_li_don_hang.html">
                            <i class="bi bi-cart"></i> Quản lý Đơn hàng
                        </a>
                    </li>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_binh_luan.html">
                            <i class="bi bi-chat-dots"></i> Quản lý Bình luận
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link " href="quan_li_tac_gia.html">
                            <i class="bi bi-people"></i> Quản lý tác giả
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link " href="quan_li_danh_muc.html">
                            <i class="bi bi-list-task"></i> Quản lý Danh mục
                        </a>
                    </li>
                </ul>
            </nav>

          <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item">
              <button class="nav-link active">Tất cả</button>
            </li>
            <li class="nav-item">
              <button class="nav-link">Chờ xác nhận</button>
            </li>
            <li class="nav-item">
              <button class="nav-link">Đang xử lý</button>
            </li>
            <li class="nav-item">
              <button class="nav-link">Đang giao</button>
            </li>
            <li class="nav-item"><button class="nav-link">Đã giao</button></li>
            <li class="nav-item"><button class="nav-link">Đã hủy</button></li>
          </ul>

          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th scope="col" style="width: 10%">Mã ĐH</th>
                      <th scope="col" style="width: 20%">Khách hàng</th>
                      <th scope="col" style="width: 15%">Ngày đặt</th>
                      <th scope="col" style="width: 15%">Tổng tiền</th>
                      <th scope="col" class="text-center" style="width: 20%">
                        Trạng thái
                      </th>
                      <th scope="col" class="text-center" style="width: 20%">
                        Hành động
                      </th>
                    </tr>
                  </thead>
                  <tbody id="orderTableBody">
                    <tr>
                      <td colspan="6" class="text-center">
                        Đang tải dữ liệu...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <nav
                aria-label="Phân trang"
                class="d-flex justify-content-center mt-3"
              >
                <ul class="pagination">
                  <li class="page-item disabled">
                    <a class="page-link" href="#">Trang trước</a>
                  </li>
                  <li class="page-item active">
                    <a class="page-link" href="#">1</a>
                  </li>
                  <li class="page-item"><a class="page-link" href="#">2</a></li>
                  <li class="page-item">
                    <a class="page-link" href="#">Trang sau</a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </main>

        <div
          class="modal fade"
          id="orderModal"
          tabindex="-1"
          aria-labelledby="orderModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="orderModalLabel">
                  Chi tiết Đơn hàng
                </h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>

              <div class="modal-body">
                <div class="row">
                  <div class="col-md-6">
                    <h5>Thông tin Khách hàng</h5>
                    <p class="mb-1">
                      <strong>Tên:</strong> <span id="modal-kh-name">...</span>
                    </p>
                    <p class="mb-1">
                      <strong>Email:</strong>
                      <span id="modal-kh-email">...</span>
                    </p>
                    <p class="mb-1">
                      <strong>SĐT:</strong> <span id="modal-kh-phone">...</span>
                    </p>
                    <hr />
                    <h5>Thông tin Giao hàng</h5>
                    <p class="mb-1">
                      <strong>Địa chỉ:</strong>
                      <span id="modal-address">...</span>
                    </p>
                    <p class="mb-1">
                      <strong>Ghi chú:</strong> <span id="modal-note">...</span>
                    </p>
                    <p class="mb-1">
                      <strong>Trạng thái:</strong>
                      <span id="modal-status">...</span>
                    </p>
                  </div>

                  <div class="col-md-6">
                    <h5>Sản phẩm trong đơn hàng</h5>
                    <ul class="list-group mb-3" id="modal-product-list"></ul>
                    <ul class="list-group">
                      <li
                        class="list-group-item d-flex justify-content-between list-group-item-secondary"
                      >
                        <h5 class="my-0">Tổng cộng</h5>
                        <h5 class="my-0" id="modal-total-price">0đ</h5>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Đóng
                </button>
                <button
                  type="button"
                  class="btn btn-danger"
                  id="btn-cancel-order"
                >
                  Hủy Đơn hàng
                </button>
                <button
                  type="button"
                  class="btn btn-primary"
                  id="btn-confirm-order"
                >
                  Xác nhận / Giao hàng
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // CẤU HÌNH API URL (Đảm bảo backend chạy port này)
      const API_URL = "http://localhost:5001/api/orders";

      // === CÁC HÀM TIỆN ÍCH (HELPER) ===
      const formatMoney = (amount) => {
        return new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(amount);
      };

      const formatDate = (dateString) => {
        if (!dateString) return "";
        const date = new Date(dateString);
        return date.toLocaleDateString("vi-VN");
      };

      const getStatusBadge = (status) => {
        switch (status) {
          case "Chờ xác nhận":
            return '<span class="badge bg-warning text-dark">Chờ xác nhận</span>';
          case "Đang xử lý":
            return '<span class="badge bg-info">Đang xử lý</span>';
          case "Đang giao":
            return '<span class="badge bg-primary">Đang giao</span>';
          case "Đã giao":
            return '<span class="badge bg-success">Đã giao</span>';
          case "Đã hủy":
            return '<span class="badge bg-danger">Đã hủy</span>';
          default:
            return `<span class="badge bg-secondary">${status}</span>`;
        }
      };

      // === LOGIC CHÍNH ===

      // 1. Chạy khi trang tải xong
      document.addEventListener("DOMContentLoaded", () => {
        fetchOrders();
      });

      // 2. Lấy danh sách đơn hàng
      async function fetchOrders() {
        try {
          const res = await fetch(API_URL);
          const orders = await res.json();
          renderOrderTable(orders);
        } catch (error) {
          console.error("Lỗi tải danh sách:", error);
          document.getElementById(
            "orderTableBody"
          ).innerHTML = `<tr><td colspan="6" class="text-center text-danger">Lỗi kết nối Server! Hãy kiểm tra Backend.</td></tr>`;
        }
      }

      // 3. Hiển thị bảng
      function renderOrderTable(orders) {
        const tableBody = document.getElementById("orderTableBody");
        tableBody.innerHTML = ""; // Xóa nội dung cũ

        if (orders.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="6" class="text-center">Chưa có đơn hàng nào.</td></tr>`;
          return;
        }

        orders.forEach((order) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td><strong>#${order.MaDH}</strong></td>
                    <td>${order.HoTen}</td>
                    <td>${order.NgayDat}</td>
                    <td>${
                      order.TongTienFormatted || formatMoney(order.TongTien)
                    }</td> 
                    <td class="text-center">${getStatusBadge(
                      order.TrạngThai || order.TrangThai
                    )}</td>
                    <td class="text-center">
                        <button onclick="viewOrderDetails(${
                          order.MaDH
                        })" class="btn btn-sm btn-outline-info" title="Xem chi tiết">
                            <i class="bi bi-eye-fill"></i> Xem
                        </button>
                        <div class="btn-group btn-group-sm ms-1">
                            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                Đổi trạng thái
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="updateOrderStatus(${
                                  order.MaDH
                                }, 'Đang xử lý')">Đang xử lý</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateOrderStatus(${
                                  order.MaDH
                                }, 'Đang giao')">Đang giao</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateOrderStatus(${
                                  order.MaDH
                                }, 'Đã giao')">Đã giao</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="cancelOrder(${
                                  order.MaDH
                                })">Hủy đơn hàng</a></li>
                            </ul>
                        </div>
                    </td>
                `;
          tableBody.appendChild(tr);
        });
      }

      // 4. Xem chi tiết (Modal)
      async function viewOrderDetails(id) {
        try {
          const res = await fetch(`${API_URL}/${id}`);
          if (!res.ok) throw new Error("Lỗi khi tải chi tiết");

          const data = await res.json();
          const info = data.info; // Thông tin chung
          const items = data.items; // Danh sách sách

          // Điền thông tin vào Modal HTML
          document.getElementById(
            "orderModalLabel"
          ).innerText = `Chi tiết Đơn hàng: #${info.MaDH}`;
          document.getElementById("modal-kh-name").innerText = info.HoTen;
          document.getElementById("modal-kh-email").innerText = info.Email;
          document.getElementById("modal-kh-phone").innerText = info.SDienThoai;
          document.getElementById("modal-address").innerText =
            info.DiaChiGiaoHang || "Không có địa chỉ";
          document.getElementById("modal-note").innerText =
            info.GhiChuGiaoHang || "Không có";
          document.getElementById("modal-status").innerHTML = getStatusBadge(
            info.TrangThai
          );

          // Nếu backend chưa format tiền thì format ở đây
          const total = info.TongTienFormatted
            ? info.TongTienFormatted
            : formatMoney(info.TongTien);
          document.getElementById("modal-total-price").innerText = total;

          // Điền danh sách sản phẩm
          const listContainer = document.getElementById("modal-product-list");
          listContainer.innerHTML = ""; // Reset list

          items.forEach((item) => {
            const li = document.createElement("li");
            li.className =
              "list-group-item d-flex justify-content-between align-items-center";
            li.innerHTML = `
                        <div>
                            <h6 class="my-0">${item.TenSach}</h6>
                            <small class="text-muted">Đơn giá: ${formatMoney(
                              item.DonGia
                            )}</small>
                        </div>
                        <span class="text-muted">SL: ${item.SoLuong}</span>
                    `;
            listContainer.appendChild(li);
          });

          // Gán sự kiện cho nút Hủy & Xác nhận trong Modal
          const btnCancel = document.getElementById("btn-cancel-order");
          btnCancel.onclick = () => cancelOrder(info.MaDH);

          const btnConfirm = document.getElementById("btn-confirm-order");
          // Logic: Nếu đang chờ thì chuyển sang Đang xử lý, nếu đang xử lý thì chuyển sang Đang giao...
          // Ở đây demo chuyển thẳng sang "Đang giao"
          btnConfirm.onclick = () => updateOrderStatus(info.MaDH, "Đang giao");

          // Mở Modal bằng Bootstrap API
          const myModal = new bootstrap.Modal(
            document.getElementById("orderModal")
          );
          myModal.show();
        } catch (error) {
          alert("Không thể tải chi tiết đơn hàng!");
          console.error(error);
        }
      }

      // 5. Cập nhật trạng thái
      async function updateOrderStatus(id, newStatus) {
        // Xác nhận trước khi làm
        if (
          !confirm(`Bạn muốn chuyển đơn #${id} sang trạng thái "${newStatus}"?`)
        )
          return;

        try {
          const res = await fetch(`${API_URL}/${id}/status`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: newStatus }),
          });

          if (res.ok) {
            alert("Cập nhật thành công!");
            fetchOrders(); // Tải lại bảng để thấy thay đổi

            // Ẩn modal nếu đang mở
            const modalEl = document.getElementById("orderModal");
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (modalInstance) modalInstance.hide();
          } else {
            const err = await res.json();
            alert("Lỗi: " + (err.message || "Không thể cập nhật"));
          }
        } catch (error) {
          console.error(error);
          alert("Lỗi kết nối server");
        }
      }

      // 6. Hủy đơn
      async function cancelOrder(id) {
        if (
          !confirm(
            `Bạn chắc chắn muốn hủy đơn hàng #${id}? Hành động này không thể hoàn tác.`
          )
        )
          return;

        try {
          const res = await fetch(`${API_URL}/${id}/cancel`, {
            method: "PUT",
          });

          if (res.ok) {
            alert("Đã hủy đơn hàng!");
            fetchOrders();

            const modalEl = document.getElementById("orderModal");
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (modalInstance) modalInstance.hide();
          } else {
            const err = await res.json();
            alert("Lỗi: " + (err.message || "Không thể hủy"));
          }
        } catch (error) {
          console.error(error);
          alert("Lỗi kết nối server");
        }
      }
    </script>
  </body>
</html>
