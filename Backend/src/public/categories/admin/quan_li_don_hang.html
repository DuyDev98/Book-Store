<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Bán Sách</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <script src="../../js/admin-guard.js"></script>

    <style>
        body {
            padding-top: 57px;
            background-color: #f5f6f8;
            margin-left: 240px;
            overflow-x: hidden; /* Ẩn thanh cuộn ngang của toàn trang */
        }

        .sidebar {
            position: fixed;
            top: 56px;
            bottom: 0;
            left: 0;
            z-index: 1000;
            padding: 20px 0;
            overflow-x: hidden;
            overflow-y: auto;
            background-color: #ffffff;
            border-right: 1px solid #dee2e6;
        }

        .sidebar .nav-link {
            color: #333;
            padding: 10px 20px;
            font-weight: 500;
        }

        .sidebar .nav-link i {
            margin-right: 8px;
        }

        .sidebar .nav-link.active {
            background-color: #0d6efd;
            color: #fff;
        }

        .sidebar .nav-link.active i {
            color: #fff;
        }

        .main-content {
            
            padding: 20px;
        }

        .card {
            border-radius: 0.5rem;
            border: 1px solid #e3e6ea;
            box-shadow: 0 2px 4px rgba(15, 34, 58, 0.05);
        }

        .table thead th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.04em;
        }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Admin Bán Sách</a>

            <div class="d-flex ms-auto">
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i> Chào, Admin!
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item text-danger" href="#" onclick="adminLogout()">Đăng xuất</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <nav class="col-md-3 col-lg-2 d-md-block sidebar" style="width: 240px">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link" href="dashboard.html"
                ><i class="bi bi-house-door"></i> Dashboard</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_sach.html"
                ><i class="bi bi-book"></i> Quản lý Sách</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_loai_sach.html"
                ><i class="bi bi-tags"></i> Quản lý Loại sách</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_nxb.html"
                ><i class="bi bi-building"></i> Quản lý NXB</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="quan_li_don_hang.html"
                ><i class="bi bi-cart"></i> Quản lý Đơn hàng</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_hoi_vien.html"
                ><i class="bi bi-people"></i> Quản lý Hội viên</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_binh_luan.html"
                ><i class="bi bi-chat-dots"></i> Quản lý Bình luận</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_phan_hoi.html"
                ><i class="bi bi-envelope"></i> Quản lý Phản hồi</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_tac_gia.html"
                ><i class="bi bi-people"></i> Quản lý tác giả</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_danh_muc.html"
                ><i class="bi bi-list-task"></i> Quản lý Danh mục</a
              >
            </li>
          </ul>
        </nav>

            <nav class="col-md-3 col-lg-2 d-md-block sidebar" style="width: 240px;">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="bi bi-house-door"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_sach.html">
                            <i class="bi bi-book"></i> Quản lý Sách
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_loai_sach.html">
                            <i class="bi bi-tags"></i> Quản lý Loại sách
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_nxb.html">
                            <i class="bi bi-building"></i> Quản lý NXB
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="quan_li_don_hang.html">
                            <i class="bi bi-cart"></i> Quản lý Đơn hàng
                        </a>
                    </li>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_binh_luan.html">
                            <i class="bi bi-chat-dots"></i> Quản lý Bình luận
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link " href="quan_li_tac_gia.html">
                            <i class="bi bi-people"></i> Quản lý tác giả
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link " href="quan_li_danh_muc.html">
                            <i class="bi bi-list-task"></i> Quản lý Danh mục
                        </a>
                    </li>
                </ul>
            </nav>

          <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item">
              <button class="nav-link active">Tất cả</button>
            </li>
            <li class="nav-item">
              <button class="nav-link">Chờ xác nhận</button>
            </li>
            <li class="nav-item">
              <button class="nav-link">Đang xử lý</button>
            </li>
            <li class="nav-item">
              <button class="nav-link">Đang giao</button>
            </li>
            <li class="nav-item"><button class="nav-link">Đã giao</button></li>
            <li class="nav-item"><button class="nav-link">Đã hủy</button></li>
          </ul>

          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th scope="col" style="width: 10%">Mã ĐH</th>
                      <th scope="col" style="width: 20%">Khách hàng</th>
                      <th scope="col" style="width: 15%">Ngày đặt</th>
                      <th scope="col" style="width: 15%">Tổng tiền</th>
                      <th scope="col" class="text-center" style="width: 20%">
                        Trạng thái
                      </th>
                      <th scope="col" class="text-center" style="width: 20%">
                        Hành động
                      </th>
                    </tr>
                  </thead>
                  <tbody id="orderTableBody">
                    <tr>
                      <td colspan="6" class="text-center">
                        Đang tải dữ liệu...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <nav aria-label="Phân trang" class="d-flex justify-content-center mt-3">
                  <ul class="pagination" id="pagination">
                      </ul>
              </nav>
            </div>
          </div>
        </main>

        <div class="modal fade" id="orderModal" tabindex="-1" aria-labelledby="orderModalLabel"  aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="orderModalLabel">
                  Chi tiết Đơn hàng
                </h5>
                <button type="button"class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="row">
                  <div class="col-md-6">
                    <h5>Thông tin Khách hàng</h5>
                    <p class="mb-1">
                      <strong>Tên:</strong> <span id="modal-kh-name">...</span>
                    </p>
                    <p class="mb-1">
                      <strong>Email:</strong>
                      <span id="modal-kh-email">...</span>
                    </p>
                    <p class="mb-1">
                      <strong>SĐT:</strong> <span id="modal-kh-phone">...</span>
                    </p>
                    <hr />
                    <h5>Thông tin Giao hàng</h5>
                    <p class="mb-1">
                      <strong>Địa chỉ:</strong>
                      <span id="modal-address">...</span>
                    </p>
                    <p class="mb-1">
                      <strong>Ghi chú:</strong> <span id="modal-note">...</span>
                    </p>
                    <p class="mb-1">
                      <strong>Trạng thái:</strong>
                      <span id="modal-status">...</span>
                    </p>
                  </div>

                  <div class="col-md-6">
                    <h5>Sản phẩm trong đơn hàng</h5>
                    <ul class="list-group mb-3" id="modal-product-list"></ul>
                    <ul class="list-group">
                      <li class="list-group-item d-flex justify-content-between list-group-item-secondary">
                        <h5 class="my-0">Tổng cộng</h5>
                        <h5 class="my-0" id="modal-total-price">0đ</h5>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"> Đóng </button>
                <button
                  type="button" class="btn btn-danger" id="btn-cancel-order"> Hủy Đơn hàng </button>
                <button type="button" class="btn btn-primary" id="btn-confirm-order">
                  Xác nhận / Giao hàng
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- CẤU HÌNH ---
        const API_URL = "http://localhost:5001/api/orders";
        
        // BIẾN TOÀN CỤC QUẢN LÝ DỮ LIỆU
        let allOrdersData = [];       // Dữ liệu gốc (Tất cả đơn hàng)
        let currentFilteredList = []; // Dữ liệu đang hiển thị (Đã lọc theo Tab)

        // CẤU HÌNH PHÂN TRANG
        let currentPage = 1;
        const rowsPerPage = 10;       // Số đơn hàng mỗi trang

        // --- CÁC HÀM HELPER (Định dạng tiền, ngày, badge) ---
        const formatMoney = (amount) => new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(amount);
        
        const formatDate = (dateString) => {
            if (!dateString) return "";
            return new Date(dateString).toLocaleDateString("vi-VN");
        };

        const getStatusBadge = (status) => {
            const map = {
                "Chờ xác nhận": "bg-warning text-dark",
                "Đang xử lý": "bg-info text-dark",
                "Đang giao": "bg-primary",
                "Đã giao": "bg-success",
                "Đã hủy": "bg-danger"
            };
            const colorClass = map[status] || "bg-secondary";
            return `<span class="badge ${colorClass}">${status}</span>`;
        };

        // --- 1. KHỞI TẠO ---
        document.addEventListener("DOMContentLoaded", () => {
            fetchOrders();
            setupFilterListeners();
        });

        // --- 2. TẢI DỮ LIỆU ---
        async function fetchOrders() {
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error("Lỗi kết nối");
                
                allOrdersData = await res.json();
                
                // Mặc định ban đầu hiển thị "Tất cả"
                currentFilteredList = [...allOrdersData]; 
                
                // Reset về trang 1 và vẽ giao diện
                currentPage = 1;
                updateView();
            } catch (error) {
                console.error("Lỗi tải danh sách:", error);
                document.getElementById("orderTableBody").innerHTML = 
                    `<tr><td colspan="6" class="text-center text-danger">Lỗi kết nối Server!</td></tr>`;
            }
        }

        // --- 3. ĐIỀU PHỐI HIỂN THỊ (CẮT TRANG) ---
        function updateView() {
            // Tính toán vị trí cắt mảng dựa trên trang hiện tại
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            
            // Cắt dữ liệu từ danh sách ĐÃ LỌC (currentFilteredList)
            const displayList = currentFilteredList.slice(startIndex, endIndex);

            renderOrderTable(displayList);
            renderPagination();
        }

        // --- 4. RENDER BẢNG ---
        function renderOrderTable(orders) {
            const tableBody = document.getElementById("orderTableBody");
            tableBody.innerHTML = ""; 

            if (orders.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Không tìm thấy đơn hàng nào.</td></tr>`;
                return;
            }

            orders.forEach((order) => {
                const status = order.TrạngThai || order.TrangThai; // Xử lý trường hợp backend trả về tên field khác nhau
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td><strong>#${order.MaDH}</strong></td>
                    <td>
                        <div class="fw-bold">${order.HoTen}</div>
                        <small class="text-muted">${order.SDienThoai || ''}</small>
                    </td>
                    <td>${formatDate(order.NgayDat)}</td>
                    <td class="fw-bold text-danger">
                        ${order.TongTienFormatted || formatMoney(order.TongTien)}
                    </td> 
                    <td class="text-center">${getStatusBadge(status)}</td>
                    <td class="text-center">
                        <button onclick="viewOrderDetails(${order.MaDH})" class="btn btn-sm btn-outline-info">
                            <i class="bi bi-eye-fill"></i> Xem
                        </button>
                        <div class="btn-group btn-group-sm ms-1">
                            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                Xử lý
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="updateOrderStatus(${order.MaDH}, 'Đang xử lý')">Đang xử lý</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateOrderStatus(${order.MaDH}, 'Đang giao')">Đang giao</a></li>
                                <li><a class="dropdown-item" href="#" onclick="updateOrderStatus(${order.MaDH}, 'Đã giao')">Đã giao</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="cancelOrder(${order.MaDH})">Hủy đơn hàng</a></li>
                            </ul>
                        </div>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // --- 5. RENDER PHÂN TRANG ---
        function renderPagination() {
            const paginationUl = document.getElementById("pagination");
            paginationUl.innerHTML = "";

            const totalPages = Math.ceil(currentFilteredList.length / rowsPerPage);

            // Nếu chỉ có 1 trang hoặc không có dữ liệu -> ẩn phân trang
            if (totalPages <= 1) return;

            // Nút Trước
            const prevClass = currentPage === 1 ? "disabled" : "";
            paginationUl.innerHTML += `
                <li class="page-item ${prevClass}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Trang trước</a>
                </li>`;

            // Các nút số
            for (let i = 1; i <= totalPages; i++) {
                const activeClass = i === currentPage ? "active" : "";
                paginationUl.innerHTML += `
                    <li class="page-item ${activeClass}">
                        <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                    </li>`;
            }

            // Nút Sau
            const nextClass = currentPage === totalPages ? "disabled" : "";
            paginationUl.innerHTML += `
                <li class="page-item ${nextClass}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Trang sau</a>
                </li>`;
        }

        function changePage(page) {
            const totalPages = Math.ceil(currentFilteredList.length / rowsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            updateView();
        }

        // --- 6. XỬ LÝ LỌC (TABS) ---
        function setupFilterListeners() {
            const filterButtons = document.querySelectorAll('#pills-tab .nav-link');
            filterButtons.forEach(btn => {
                btn.onclick = function () {
                    // UI: Đổi màu tab active
                    filterButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // LOGIC: Lọc dữ liệu
                    const statusToFilter = this.innerText.trim();
                    
                    if (statusToFilter === "Tất cả") {
                        currentFilteredList = [...allOrdersData];
                    } else {
                        currentFilteredList = allOrdersData.filter(order => {
                            const s = order.TrangThai || order.TrạngThai; // Fix lỗi chính tả backend nếu có
                            return s === statusToFilter;
                        });
                    }

                    // QUAN TRỌNG: Khi lọc xong phải reset về trang 1
                    currentPage = 1;
                    updateView();
                };
            });
        }

        // --- 7. CÁC HÀM XỬ LÝ MODAL & API (Giữ nguyên logic cũ nhưng thêm reload) ---

        async function viewOrderDetails(id) {
            try {
                const res = await fetch(`${API_URL}/${id}`);
                if (!res.ok) throw new Error("Lỗi tải chi tiết");
                const data = await res.json();
                const info = data.info;
                const items = data.items;

                document.getElementById("orderModalLabel").innerText = `Đơn hàng #${info.MaDH}`;
                document.getElementById("modal-kh-name").innerText = info.HoTen;
                document.getElementById("modal-kh-email").innerText = info.Email;
                document.getElementById("modal-kh-phone").innerText = info.SDienThoai;
                document.getElementById("modal-address").innerText = info.DiaChiGiaoHang || "N/A";
                document.getElementById("modal-note").innerText = info.GhiChuGiaoHang || "Không";
                document.getElementById("modal-status").innerHTML = getStatusBadge(info.TrangThai);
                document.getElementById("modal-total-price").innerText = info.TongTienFormatted || formatMoney(info.TongTien);

                const listContainer = document.getElementById("modal-product-list");
                listContainer.innerHTML = items.map(item => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="my-0">${item.TenSach}</h6>
                            <small class="text-muted">${formatMoney(item.DonGia)}</small>
                        </div>
                        <span class="badge bg-secondary rounded-pill">x${item.SoLuong}</span>
                    </li>
                `).join('');

                // Gán sự kiện nút bấm trong modal
                document.getElementById("btn-cancel-order").onclick = () => cancelOrder(info.MaDH);
                document.getElementById("btn-confirm-order").onclick = () => updateOrderStatus(info.MaDH, 'Đang giao');

                new bootstrap.Modal(document.getElementById("orderModal")).show();
            } catch (error) {
                console.error(error);
                alert("Lỗi tải chi tiết đơn hàng");
            }
        }

        async function updateOrderStatus(id, newStatus) {
            if (!confirm(`Cập nhật đơn #${id} sang "${newStatus}"?`)) return;
            try {
                const res = await fetch(`${API_URL}/${id}/status`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ status: newStatus }),
                });
                if (res.ok) {
                    alert("Cập nhật thành công!");
                    // Ẩn modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById("orderModal"));
                    if (modal) modal.hide();
                    // Tải lại dữ liệu để cập nhật danh sách
                    fetchOrders(); 
                } else {
                    alert("Lỗi cập nhật trạng thái");
                }
            } catch (err) { alert("Lỗi server"); }
        }

        async function cancelOrder(id) {
            if (!confirm(`Hủy đơn hàng #${id}? Hành động này không thể hoàn tác.`)) return;
            try {
                const res = await fetch(`${API_URL}/${id}/cancel`, { method: "PUT" });
                if (res.ok) {
                    alert("Đã hủy đơn hàng!");
                    const modal = bootstrap.Modal.getInstance(document.getElementById("orderModal"));
                    if (modal) modal.hide();
                    fetchOrders();
                } else {
                    alert("Không thể hủy đơn hàng này");
                }
            } catch (err) { alert("Lỗi server"); }
        }
    </script>
  </body>
</html>