<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Bán Sách</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <script src="../../js/admin-guard.js"></script>

    <style>
        body {
            padding-top: 57px;
            background-color: #f5f6f8;
            margin-left: 240px;
            overflow-x: hidden; /* Ẩn thanh cuộn ngang của toàn trang */
        }

        .sidebar {
            position: fixed;
            top: 56px;
            bottom: 0;
            left: 0;
            z-index: 1000;
            padding: 20px 0;
            overflow-x: hidden;
            overflow-y: auto;
            background-color: #ffffff;
            border-right: 1px solid #dee2e6;
        }

        .sidebar .nav-link {
            color: #333;
            padding: 10px 20px;
            font-weight: 500;
        }

        .sidebar .nav-link i {
            margin-right: 8px;
        }

        .sidebar .nav-link.active {
            background-color: #0d6efd;
            color: #fff;
        }

        .sidebar .nav-link.active i {
            color: #fff;
        }

        .main-content {
            
            padding: 20px;
        }

        .card {
            border-radius: 0.5rem;
            border: 1px solid #e3e6ea;
            box-shadow: 0 2px 4px rgba(15, 34, 58, 0.05);
        }

        .table thead th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.04em;
        }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Admin Bán Sách</a>

            <div class="d-flex ms-auto">
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i> Chào, Admin!
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item text-danger" href="#" onclick="adminLogout()">Đăng xuất</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <nav class="col-md-3 col-lg-2 d-md-block sidebar" style="width: 240px">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link" href="dashboard.html"
                ><i class="bi bi-house-door"></i> Dashboard</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_sach.html"
                ><i class="bi bi-book"></i> Quản lý Sách</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_loai_sach.html"
                ><i class="bi bi-tags"></i> Quản lý Loại sách</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_nxb.html"
                ><i class="bi bi-building"></i> Quản lý NXB</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="quan_li_don_hang.html"
                ><i class="bi bi-cart"></i> Quản lý Đơn hàng</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_hoi_vien.html"
                ><i class="bi bi-people"></i> Quản lý Hội viên</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_binh_luan.html"
                ><i class="bi bi-chat-dots"></i> Quản lý Bình luận</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_phan_hoi.html"
                ><i class="bi bi-envelope"></i> Quản lý Phản hồi</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_tac_gia.html"
                ><i class="bi bi-people"></i> Quản lý tác giả</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_danh_muc.html"
                ><i class="bi bi-list-task"></i> Quản lý Danh mục</a
              >
            </li>
          </ul>
        </nav>

            <nav class="col-md-3 col-lg-2 d-md-block sidebar" style="width: 240px;">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="bi bi-house-door"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_sach.html">
                            <i class="bi bi-book"></i> Quản lý Sách
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_loai_sach.html">
                            <i class="bi bi-tags"></i> Quản lý Loại sách
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_nxb.html">
                            <i class="bi bi-building"></i> Quản lý NXB
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="quan_li_don_hang.html">
                            <i class="bi bi-cart"></i> Quản lý Đơn hàng
                        </a>
                    </li>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="quan_li_binh_luan.html">
                            <i class="bi bi-chat-dots"></i> Quản lý Bình luận
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link " href="quan_li_tac_gia.html">
                            <i class="bi bi-people"></i> Quản lý tác giả
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link " href="quan_li_danh_muc.html">
                            <i class="bi bi-list-task"></i> Quản lý Danh mục
                        </a>
                    </li>
                </ul>
            </nav>

          <ul class="nav nav-pills mb-3" id="pills-tab">
              <li class="nav-item">
                  <button class="nav-link active" onclick="filterByTab(this, 'all')">Tất cả</button>
              </li>
              <li class="nav-item">
                  <button class="nav-link" onclick="filterByTab(this, 'Chờ xác nhận')">Chờ xác nhận</button>
              </li>
              <li class="nav-item">
                  <button class="nav-link" onclick="filterByTab(this, 'Đang xử lý')">Đang xử lý</button>
              </li>
              <li class="nav-item">
                  <button class="nav-link" onclick="filterByTab(this, 'Đang giao')">Đang giao</button>
              </li>
              <li class="nav-item">
                  <button class="nav-link" onclick="filterByTab(this, 'Đã giao')">Đã giao</button>
              </li>
              <li class="nav-item">
                  <button class="nav-link" onclick="filterByTab(this, 'Đã hủy')">Đã hủy</button>
              </li>
          </ul>

          <nav aria-label="Phân trang" class="d-flex justify-content-center mt-3">
              <ul class="pagination" id="pagination">
                  </ul>
          </nav>

          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th scope="col" style="width: 10%">Mã ĐH</th>
                      <th scope="col" style="width: 20%">Khách hàng</th>
                      <th scope="col" style="width: 15%">Ngày đặt</th>
                      <th scope="col" style="width: 15%">Tổng tiền</th>
                      <th scope="col" class="text-center" style="width: 20%">
                        Trạng thái
                      </th>
                      <th scope="col" class="text-center" style="width: 20%">
                        Hành động
                      </th>
                    </tr>
                  </thead>
                  <tbody id="orderTableBody">
                    <tr>
                      <td colspan="6" class="text-center">
                        Đang tải dữ liệu...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <nav
                aria-label="Phân trang"
                class="d-flex justify-content-center mt-3"
              >
                <ul class="pagination">
                  <li class="page-item disabled">
                    <a class="page-link" href="#">Trang trước</a>
                  </li>
                  <li class="page-item active">
                    <a class="page-link" href="#">1</a>
                  </li>
                  <li class="page-item"><a class="page-link" href="#">2</a></li>
                  <li class="page-item">
                    <a class="page-link" href="#">Trang sau</a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </main>

        <div
          class="modal fade"
          id="orderModal"
          tabindex="-1"
          aria-labelledby="orderModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="orderModalLabel">
                  Chi tiết Đơn hàng
                </h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>

              <div class="modal-body">
                <div class="row">
                  <div class="col-md-6">
                    <h5>Thông tin Khách hàng</h5>
                    <p class="mb-1">
                      <strong>Tên:</strong> <span id="modal-kh-name">...</span>
                    </p>
                    <p class="mb-1">
                      <strong>Email:</strong>
                      <span id="modal-kh-email">...</span>
                    </p>
                    <p class="mb-1">
                      <strong>SĐT:</strong> <span id="modal-kh-phone">...</span>
                    </p>
                    <hr />
                    <h5>Thông tin Giao hàng</h5>
                    <p class="mb-1">
                      <strong>Địa chỉ:</strong>
                      <span id="modal-address">...</span>
                    </p>
                    <p class="mb-1">
                      <strong>Ghi chú:</strong> <span id="modal-note">...</span>
                    </p>
                    <p class="mb-1">
                      <strong>Trạng thái:</strong>
                      <span id="modal-status">...</span>
                    </p>
                  </div>

                  <div class="col-md-6">
                    <h5>Sản phẩm trong đơn hàng</h5>
                    <ul class="list-group mb-3" id="modal-product-list"></ul>
                    <ul class="list-group">
                      <li
                        class="list-group-item d-flex justify-content-between list-group-item-secondary"
                      >
                        <h5 class="my-0">Tổng cộng</h5>
                        <h5 class="my-0" id="modal-total-price">0đ</h5>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Đóng
                </button>
                <button
                  type="button"
                  class="btn btn-danger"
                  id="btn-cancel-order"
                >
                  Hủy Đơn hàng
                </button>
                <button
                  type="button"
                  class="btn btn-primary"
                  id="btn-confirm-order"
                >
                  Xác nhận / Giao hàng
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    // --- CẤU HÌNH ---
    const API_URL = "http://localhost:5001/api/orders";
    
    // Biến toàn cục quản lý dữ liệu và phân trang
    let allOrders = [];         // Chứa toàn bộ đơn hàng từ API
    let currentOrders = [];     // Chứa đơn hàng đang hiển thị (sau khi lọc Tab)
    
    let currentPage = 1;        // Trang hiện tại
    const rowsPerPage = 10;     // Số đơn hàng mỗi trang

    // --- 1. KHỞI TẠO ---
    document.addEventListener("DOMContentLoaded", () => {
        fetchOrders();
    });

    // --- 2. TẢI DỮ LIỆU ---
    async function fetchOrders() {
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            
            // Xử lý dữ liệu trả về (mảng hoặc object)
            allOrders = Array.isArray(data) ? data : (data.data || []);
            
            // Mặc định ban đầu hiển thị tất cả
            currentOrders = [...allOrders];
            
            updateView(); // Vẽ giao diện
            updateTabBadges(); // (Tùy chọn) Cập nhật số lượng trên Tab nếu muốn

        } catch (error) {
            console.error("Lỗi tải danh sách:", error);
            document.getElementById("orderTableBody").innerHTML = 
                `<tr><td colspan="6" class="text-center text-danger">Lỗi kết nối Server!</td></tr>`;
        }
    }

    // --- 3. ĐIỀU PHỐI HIỂN THỊ (Core Logic) ---
    function updateView() {
        renderOrderTable(currentOrders);
        renderPagination(currentOrders);
    }

    // --- 4. RENDER BẢNG (Theo trang) ---
    function renderOrderTable(list) {
        const tableBody = document.getElementById("orderTableBody");
        tableBody.innerHTML = "";

        if (list.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4">Không tìm thấy đơn hàng nào.</td></tr>`;
            return;
        }

        // Tính toán vị trí cắt mảng (Pagination Logic)
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;
        const pageItems = list.slice(startIndex, endIndex);

        pageItems.forEach((order) => {
            const tr = document.createElement("tr");
            
            const money = order.TongTienFormatted || formatMoney(order.TongTien);
            const status = order.TrạngThai || order.TrangThai; // Handle case sensitive keys
            const date = formatDate(order.NgayDat);

            tr.innerHTML = `
                <td><strong>#${order.MaDH}</strong></td>
                <td>
                    <div class="fw-bold">${order.HoTen || 'Khách lẻ'}</div>
                    <small class="text-muted">${order.SDienThoai || ''}</small>
                </td>
                <td>${date}</td>
                <td class="text-danger fw-bold">${money}</td>
                <td class="text-center">${getStatusBadge(status)}</td>
                <td class="text-center">
                    <button onclick="viewOrderDetails(${order.MaDH})" class="btn btn-sm btn-outline-info" title="Xem chi tiết">
                        <i class="bi bi-eye-fill"></i> Xem
                    </button>
                    <div class="btn-group btn-group-sm ms-1">
                        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-gear-fill"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="updateOrderStatus(${order.MaDH}, 'Đang xử lý')">Đang xử lý</a></li>
                            <li><a class="dropdown-item" href="#" onclick="updateOrderStatus(${order.MaDH}, 'Đang giao')">Đang giao</a></li>
                            <li><a class="dropdown-item" href="#" onclick="updateOrderStatus(${order.MaDH}, 'Đã giao')">Đã giao</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="cancelOrder(${order.MaDH})">Hủy đơn hàng</a></li>
                        </ul>
                    </div>
                </td>
            `;
            tableBody.appendChild(tr);
        });
    }

    // --- 5. RENDER PHÂN TRANG ---
    function renderPagination(list) {
        const paginationUl = document.getElementById('pagination');
        if (!paginationUl) return;
        paginationUl.innerHTML = "";

        const totalPages = Math.ceil(list.length / rowsPerPage);

        // Ẩn phân trang nếu chỉ có 1 trang hoặc không có dữ liệu
        if (totalPages <= 1) return;

        // Nút Trước
        const prevClass = currentPage === 1 ? 'disabled' : '';
        paginationUl.innerHTML += `
            <li class="page-item ${prevClass}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Trang trước</a>
            </li>
        `;

        // Các nút số trang
        for (let i = 1; i <= totalPages; i++) {
            const activeClass = i === currentPage ? 'active' : '';
            paginationUl.innerHTML += `
                <li class="page-item ${activeClass}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>
            `;
        }

        // Nút Sau
        const nextClass = currentPage === totalPages ? 'disabled' : '';
        paginationUl.innerHTML += `
            <li class="page-item ${nextClass}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Trang sau</a>
            </li>
        `;
    }

    // Hàm chuyển trang
    function changePage(page) {
        const totalPages = Math.ceil(currentOrders.length / rowsPerPage);
        if (page < 1 || page > totalPages) return;
        
        currentPage = page;
        updateView();
    }

    // --- 6. LỌC THEO TAB (TRẠNG THÁI) ---
    function filterByTab(btn, status) {
        // 1. Cập nhật giao diện Tab (Active class)
        const buttons = document.querySelectorAll('#pills-tab .nav-link');
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // 2. Lọc dữ liệu
        if (status === 'all') {
            currentOrders = [...allOrders];
        } else {
            currentOrders = allOrders.filter(o => {
                const s = o.TrạngThai || o.TrangThai; // Handle case sensitive
                return s === status;
            });
        }

        // 3. Reset về trang 1 và vẽ lại
        currentPage = 1;
        updateView();
    }

    // --- CÁC HÀM XỬ LÝ (MODAL, UPDATE, CANCEL) - GIỮ NGUYÊN ---

    async function viewOrderDetails(id) {
        try {
            const res = await fetch(`${API_URL}/${id}`);
            if (!res.ok) throw new Error("Lỗi tải chi tiết");
            const data = await res.json();
            
            const info = data.info || data; // Tùy cấu trúc API
            const items = data.items || [];

            // Điền info
            document.getElementById("orderModalLabel").innerText = `Chi tiết Đơn hàng: #${info.MaDH}`;
            document.getElementById("modal-kh-name").innerText = info.HoTen;
            document.getElementById("modal-kh-email").innerText = info.Email || '-';
            document.getElementById("modal-kh-phone").innerText = info.SDienThoai || '-';
            document.getElementById("modal-address").innerText = info.DiaChiGiaoHang || "Tại cửa hàng";
            document.getElementById("modal-note").innerText = info.GhiChuGiaoHang || "Không";
            document.getElementById("modal-status").innerHTML = getStatusBadge(info.TrangThai);
            
            // Điền items
            const listContainer = document.getElementById("modal-product-list");
            listContainer.innerHTML = "";
            let totalCalc = 0;

            if(items.length > 0) {
                items.forEach(item => {
                    totalCalc += (item.DonGia * item.SoLuong);
                    listContainer.innerHTML += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="my-0">${item.TenSach}</h6>
                                <small class="text-muted">${formatMoney(item.DonGia)} x ${item.SoLuong}</small>
                            </div>
                            <span class="text-muted fw-bold">${formatMoney(item.DonGia * item.SoLuong)}</span>
                        </li>
                    `;
                });
            } else {
                listContainer.innerHTML = '<li class="list-group-item text-center">Không có sản phẩm</li>';
            }

            const finalTotal = info.TongTienFormatted || formatMoney(info.TongTien || totalCalc);
            document.getElementById("modal-total-price").innerText = finalTotal;

            // Gán sự kiện nút modal
            document.getElementById("btn-cancel-order").onclick = () => cancelOrder(info.MaDH);
            document.getElementById("btn-confirm-order").onclick = () => updateOrderStatus(info.MaDH, "Đang giao");

            const myModal = new bootstrap.Modal(document.getElementById("orderModal"));
            myModal.show();

        } catch (error) {
            console.error(error);
            alert("Không thể tải chi tiết đơn hàng!");
        }
    }

    async function updateOrderStatus(id, newStatus) {
        if (!confirm(`Chuyển trạng thái đơn #${id} sang "${newStatus}"?`)) return;
        try {
            const res = await fetch(`${API_URL}/${id}/status`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: newStatus }),
            });
            if (res.ok) {
                alert("Thành công!");
                // Ẩn modal và reload
                const modalEl = document.getElementById("orderModal");
                const modal = bootstrap.Modal.getInstance(modalEl);
                if(modal) modal.hide();
                fetchOrders();
            } else {
                alert("Lỗi cập nhật!");
            }
        } catch (e) { alert("Lỗi kết nối!"); }
    }

    async function cancelOrder(id) {
        if (!confirm(`Hủy đơn hàng #${id}? Hành động này không thể hoàn tác.`)) return;
        try {
            const res = await fetch(`${API_URL}/${id}/cancel`, { method: "PUT" });
            if (res.ok) {
                alert("Đã hủy đơn hàng!");
                const modalEl = document.getElementById("orderModal");
                const modal = bootstrap.Modal.getInstance(modalEl);
                if(modal) modal.hide();
                fetchOrders();
            } else {
                alert("Không thể hủy đơn hàng này.");
            }
        } catch (e) { alert("Lỗi kết nối!"); }
    }

    // --- HELPER FUNCTIONS ---
    function formatMoney(amount) {
        return new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(amount);
    }

    function formatDate(dateString) {
        if (!dateString) return "";
        return new Date(dateString).toLocaleDateString("vi-VN");
    }

    function getStatusBadge(status) {
        switch (status) {
            case "Chờ xác nhận": return '<span class="badge bg-warning text-dark">Chờ xác nhận</span>';
            case "Đang xử lý": return '<span class="badge bg-info">Đang xử lý</span>';
            case "Đang giao": return '<span class="badge bg-primary">Đang giao</span>';
            case "Đã giao": return '<span class="badge bg-success">Đã giao</span>';
            case "Đã hủy": return '<span class="badge bg-danger">Đã hủy</span>';
            default: return `<span class="badge bg-secondary">${status}</span>`;
        }
    }
</script>
  </body>
</html>