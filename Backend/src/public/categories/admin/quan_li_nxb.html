<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Bán Sách</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <style>
      body {
        /* Thêm padding ở trên cùng để nội dung không bị Navbar che khuất */
        padding-top: 56px;
      }

      /* Tùy chỉnh cho Sidebar */
      .sidebar {
        position: fixed; /* Cố định sidebar */
        top: 56px; /* Ngay dưới Navbar */
        bottom: 0;
        left: 0;
        z-index: 1000;
        padding: 20px 0;
        overflow-x: hidden;
        overflow-y: auto; /* Cho phép cuộn nếu menu quá dài */
        background-color: #f8f9fa; /* Màu nền xám nhạt */
        border-right: 1px solid #dee2e6;
      }

      /* Căn lề cho Nội dung chính */
      .main-content {
        /* Đẩy nội dung sang phải một khoảng bằng chiều rộng Sidebar */
        margin-left: 240px; /* Cần khớp với chiều rộng .sidebar */
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Admin Bán Sách</a>

        <div class="d-flex ms-auto">
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarDropdown"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <i class="bi bi-person-circle"></i> Chào, Admin!
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="navbarDropdown"
              >
                <li><a class="dropdown-item" href="#">Thông tin cá nhân</a></li>
                <li><hr class="dropdown-divider" /></li>
                <li><a class="dropdown-item" href="#">Đăng xuất</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <nav class="col-md-3 col-lg-2 d-md-block sidebar" style="width: 240px">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" href="dashboard.html">
                <i class="bi bi-house-door"></i> Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_sach.html">
                <i class="bi bi-book"></i> Quản lý Sách
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_loai_sach.html">
                <i class="bi bi-tags"></i> Quản lý Loại sách
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_nxb.html">
                <i class="bi bi-building"></i> Quản lý NXB
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_don_hang.html">
                <i class="bi bi-cart"></i> Quản lý Đơn hàng
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_binh_luan.html">
                <i class="bi bi-chat-dots"></i> Quản lý Bình luận
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="quan_li_phan_hoi.html">
                <i class="bi bi-envelope"></i> Quản lý Phản hồi
              </a>
            </li>
          </ul>
        </nav>

        <main class="main-content">
          <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
          >
            <h1 class="h2">Quản lý Nhà xuất bản</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
              <button type="button" class="btn btn-primary" id="btnOpenAdd">
                <i class="bi bi-building-add"></i> Thêm NXB mới
              </button>
            </div>
          </div>

          <div class="card mb-3">
            <div class="card-body">
              <div class="row">
                <div class="col-md-12">
                  <div class="input-group">
                    <!-- thêm id để JS xử lý search -->
                    <input
                      id="publisherSearch"
                      type="text"
                      class="form-control"
                      placeholder="Tìm kiếm theo tên NXB, địa chỉ, SĐT..."
                    />
                    <button
                      class="btn btn-outline-secondary"
                      type="button"
                      id="btnSearch"
                    >
                      <i class="bi bi-search"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <div class="table-responsive">
                <!-- giữ nguyên giao diện; chỉ thêm id vào tbody để JS thay nội dung -->
                <table class="table table-striped table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th scope="col" class="text-center" style="width: 5%">
                        #
                      </th>
                      <th scope="col" style="width: 25%">Tên Nhà xuất bản</th>
                      <th scope="col" style="width: 45%">Địa chỉ</th>
                      <th scope="col" style="width: 15%">Năm thành lập</th>
                      <th scope="col" class="text-center" style="width: 15%">
                        Hành động
                      </th>
                    </tr>
                  </thead>
                  <tbody id="publisher-tbody">
                    <!-- Nội dung sẽ được JS load động -->
                  </tbody>
                </table>
              </div>

              <nav
                aria-label="Phân trang danh sách"
                class="d-flex justify-content-center mt-3"
              >
                <ul class="pagination">
                  <li class="page-item disabled">
                    <a
                      class="page-link"
                      href="#"
                      tabindex="-1"
                      aria-disabled="true"
                      >Trang trước</a
                    >
                  </li>
                  <li class="page-item active" aria-current="page">
                    <a class="page-link" href="#">1</a>
                  </li>
                  <li class="page-item">
                    <a class="page-link" href="#">Trang sau</a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </main>

        <!-- Modal thêm / sửa (dùng chung) -->
        <div
          class="modal fade"
          id="publisherModal"
          tabindex="-1"
          aria-labelledby="publisherModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="publisherModalLabel">
                  Thông tin Nhà xuất bản
                </h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>

              <div class="modal-body">
                <form id="publisherForm">
                  <input type="hidden" id="publisherId" />
                  <div class="mb-3">
                    <label for="publisherName" class="form-label"
                      >Tên Nhà xuất bản</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="publisherName"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="publisherAddress" class="form-label"
                      >Địa chỉ</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="publisherAddress"
                    />
                  </div>

                  <!-- thêm trường Năm thành lập (để lưu vào DB) -->
                  <div class="mb-3">
                    <label for="publisherYear" class="form-label"
                      >Năm thành lập</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="publisherYear"
                      placeholder="Ví dụ: 1999"
                    />
                  </div>

                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="publisherEmail" class="form-label"
                          >Email</label
                        >
                        <input
                          type="email"
                          class="form-control"
                          id="publisherEmail"
                        />
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="publisherPhone" class="form-label"
                          >Số điện thoại</label
                        >
                        <input
                          type="tel"
                          class="form-control"
                          id="publisherPhone"
                        />
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="publisherDescription" class="form-label"
                      >Mô tả / Giới thiệu</label
                    >
                    <textarea
                      class="form-control"
                      id="publisherDescription"
                      rows="4"
                    ></textarea>
                  </div>
                </form>
              </div>

              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Đóng
                </button>
                <!-- nút dùng chung cho thêm/sửa -->
                <button
                  type="button"
                  class="btn btn-primary"
                  id="savePublisherButton"
                >
                  Lưu lại
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Giữ nguyên các modal khác (bookModal, userModal,...) không chỉnh để đảm bảo giao diện giống gốc -->
        <div
          class="modal fade"
          id="bookModal"
          tabindex="-1"
          aria-labelledby="bookModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="bookModalLabel">Thông tin Sách</h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body">
                <!-- giữ nguyên nội dung ban đầu (không thay đổi) -->
                <form id="bookForm">
                  <div class="row">
                    <div class="col-md-8">
                      <div class="mb-3">
                        <label for="bookTitle" class="form-label"
                          >Tên sách</label
                        >
                        <input
                          type="text"
                          class="form-control"
                          id="bookTitle"
                          required
                        />
                      </div>
                      <div class="mb-3">
                        <label for="bookAuthor" class="form-label"
                          >Tác giả</label
                        >
                        <input
                          type="text"
                          class="form-control"
                          id="bookAuthor"
                          required
                        />
                      </div>
                      <div class="row">
                        <div class="col-6">
                          <div class="mb-3">
                            <label for="bookCategory" class="form-label"
                              >Loại sách</label
                            >
                            <select
                              class="form-select"
                              id="bookCategory"
                              required
                            >
                              <option value="">Chọn loại sách...</option>
                              <option value="1">Văn học</option>
                              <option value="2">Kinh tế</option>
                              <option value="3">Thiếu nhi</option>
                            </select>
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="mb-3">
                            <label for="bookPublisher" class="form-label"
                              >Nhà xuất bản</label
                            >
                            <select class="form-select" id="bookPublisher">
                              <option value="">Chọn NXB...</option>
                              <option value="1">NXB Kim Đồng</option>
                              <option value="2">NXB Trẻ</option>
                            </select>
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-6">
                          <div class="mb-3">
                            <label for="bookPrice" class="form-label"
                              >Giá bán</label
                            >
                            <input
                              type="number"
                              class="form-control"
                              id="bookPrice"
                              required
                            />
                          </div>
                        </div>
                        <div class="col-6">
                          <div class="mb-3">
                            <label for="bookStock" class="form-label"
                              >Số lượng tồn kho</label
                            >
                            <input
                              type="number"
                              class="form-control"
                              id="bookStock"
                              required
                            />
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-4">
                      <div class="mb-3">
                        <label for="bookCover" class="form-label"
                          >Ảnh bìa</label
                        >
                        <img
                          src="https://via.placeholder.com/150x200"
                          id="coverPreview"
                          class="img-thumbnail mb-2"
                          alt="Xem trước ảnh bìa"
                          style="width: 100%; object-fit: contain"
                        />
                        <input
                          class="form-control"
                          type="file"
                          id="bookCover"
                        />
                      </div>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="bookDescription" class="form-label"
                      >Mô tả</label
                    >
                    <textarea
                      class="form-control"
                      id="bookDescription"
                      rows="5"
                    ></textarea>
                  </div>
                </form>
              </div>

              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Đóng
                </button>
                <button
                  type="button"
                  class="btn btn-primary"
                  id="saveBookButton"
                >
                  Lưu lại
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ========== LOGIC JS CRUD CHO NHÀ XUẤT BẢN ========== -->
    <script>
      (function () {
        const API_URL = "http://localhost:5001/api/nxb"; // nếu backend khác, sửa ở đây

        // helper: escape html to prevent breaking table when names have quotes
        function escapeHtml(str) {
          if (str === null || str === undefined) return "";
          return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        // Lấy danh sách NXB và render vào table
        async function loadPublishers() {
          try {
            const res = await fetch(API_URL);
            const json = await res.json();
            // backend có thể trả về {status: "OK", data: [...] } hoặc trực tiếp [...];
            const rows = Array.isArray(json) ? json : json.data || json;
            const tbody = document.getElementById("publisher-tbody");
            tbody.innerHTML = "";

            if (!rows || rows.length === 0) {
              tbody.innerHTML = `
                          <tr>
                              <td class="text-center" colspan="5">Chưa có Nhà xuất bản nào.</td>
                          </tr>
                      `;
              return;
            }

            rows.forEach((r, idx) => {
              const id = r.MaNXB ?? r.id ?? "";
              const name = escapeHtml(r.TenNXB ?? "");
              const address = escapeHtml(r.DiaChi ?? "");
              const year = escapeHtml(r.NamThanhLap ?? "");
              const email = escapeHtml(r.Email ?? r.publisherEmail ?? "");
              const phone = escapeHtml(r.Phone ?? r.publisherPhone ?? "");

              tbody.innerHTML += `
                          <tr data-id="${id}">
                              <td class="text-center">${idx + 1}</td>
                              <td><strong>${name}</strong></td>
                              <td>${address || "-"}</td>
                              <td>${year || "-"}</td>
                              <td class="text-center">
                                  <div class="btn-group btn-group-sm" role="group">
                                      <button type="button" class="btn btn-outline-primary" title="Sửa" data-action="edit" data-id="${id}">
                                          <i class="bi bi-pencil-fill"></i>
                                      </button>
                                      <button type="button" class="btn btn-outline-danger" title="Xóa" data-action="delete" data-id="${id}">
                                          <i class="bi bi-trash-fill"></i>
                                      </button>
                                  </div>
                              </td>
                          </tr>
                      `;
            });
          } catch (err) {
            console.error("Load publishers error:", err);
            const tbody = document.getElementById("publisher-tbody");
            tbody.innerHTML = `<tr><td colspan="5" class="text-danger text-center">Không thể load dữ liệu NXB.</td></tr>`;
          }
        }

        // Open modal for add
        function openAddModal() {
          clearPublisherForm();
          document.getElementById("publisherModalLabel").textContent =
            "Thêm Nhà xuất bản";
          document.getElementById("publisherId").value = "";
          const modal = new bootstrap.Modal(
            document.getElementById("publisherModal")
          );
          modal.show();
        }

        // Open modal for edit: fetch the single publisher (optional) or use list data
        async function openEditModal(id) {
          try {
            // try to fetch single item (if backend supports it), fallback to loading all and finding
            let publisher = null;
            try {
              const res = await fetch(`${API_URL}/${id}`);
              if (res.ok) {
                const j = await res.json();
                publisher = j.data || j;
              }
            } catch (e) {
              // ignore; try fallback
            }

            if (!publisher) {
              // fallback: load all and find
              const allRes = await fetch(API_URL);
              const allJson = await allRes.json();
              const rows = Array.isArray(allJson)
                ? allJson
                : allJson.data || allJson;
              publisher = rows.find((x) => (x.MaNXB ?? x.id) == id);
            }

            if (!publisher) {
              alert("Không tìm thấy Nhà xuất bản để chỉnh sửa.");
              return;
            }

            // fill form
            document.getElementById("publisherId").value =
              publisher.MaNXB ?? publisher.id ?? "";
            document.getElementById("publisherName").value =
              publisher.TenNXB ?? "";
            document.getElementById("publisherAddress").value =
              publisher.DiaChi ?? "";
            document.getElementById("publisherYear").value =
              publisher.NamThanhLap ?? "";
            // extra fields (may be absent in DB)
            document.getElementById("publisherEmail").value =
              publisher.Email ?? publisher.publisherEmail ?? "";
            document.getElementById("publisherPhone").value =
              publisher.Phone ?? publisher.publisherPhone ?? "";
            document.getElementById("publisherDescription").value =
              publisher.Description ?? publisher.MoTa ?? "";

            document.getElementById("publisherModalLabel").textContent =
              "Sửa Nhà xuất bản";
            const modal = new bootstrap.Modal(
              document.getElementById("publisherModal")
            );
            modal.show();
          } catch (err) {
            console.error("openEditModal error:", err);
            alert("Lỗi khi mở form sửa.");
          }
        }

        // Clear form fields
        function clearPublisherForm() {
          document.getElementById("publisherForm").reset();
          document.getElementById("publisherId").value = "";
        }

        // Save (create or update)
        async function savePublisher() {
          const id = document.getElementById("publisherId").value;
          const payload = {
            TenNXB: document.getElementById("publisherName").value.trim(),
            DiaChi: document.getElementById("publisherAddress").value.trim(),
            NamThanhLap: document.getElementById("publisherYear").value
              ? Number(document.getElementById("publisherYear").value)
              : null,
            // các trường phụ (không bắt buộc ở DB, backend có thể ignore)
            Email: document.getElementById("publisherEmail").value.trim(),
            Phone: document.getElementById("publisherPhone").value.trim(),
            Description: document
              .getElementById("publisherDescription")
              .value.trim(),
          };

          // validation cơ bản
          if (!payload.TenNXB) {
            alert("Vui lòng nhập tên nhà xuất bản.");
            return;
          }

          try {
            if (id) {
              // update
              const res = await fetch(`${API_URL}/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              const j = await res.json();
              if (!res.ok) throw new Error(j.message || "Lỗi update");
              // hide modal
              bootstrap.Modal.getInstance(
                document.getElementById("publisherModal")
              ).hide();
              await loadPublishers();
              showToast("Cập nhật Nhà xuất bản thành công.");
            } else {
              // create
              const res = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              const j = await res.json();
              if (!res.ok) throw new Error(j.message || "Lỗi tạo mới");
              bootstrap.Modal.getInstance(
                document.getElementById("publisherModal")
              ).hide();
              await loadPublishers();
              showToast("Thêm Nhà xuất bản thành công.");
            }
          } catch (err) {
            console.error("savePublisher error:", err);
            alert("Lỗi khi lưu Nhà xuất bản: " + (err.message || err));
          }
        }

        // Delete publisher
        async function deletePublisher(id) {
          if (!confirm("Bạn có chắc muốn xoá Nhà xuất bản này không?")) return;
          try {
            const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
            const j = await res.json();
            if (!res.ok) throw new Error(j.message || "Lỗi xóa");
            await loadPublishers();
            showToast("Xóa Nhà xuất bản thành công.");
          } catch (err) {
            console.error("deletePublisher error:", err);
            alert("Lỗi khi xóa: " + (err.message || err));
          }
        }

        // Simple client-side search
        function applySearch() {
          const q = document
            .getElementById("publisherSearch")
            .value.trim()
            .toLowerCase();
          const rows = document.querySelectorAll("#publisher-tbody tr");
          rows.forEach((tr) => {
            if (!q) {
              tr.style.display = "";
              return;
            }
            const text = tr.textContent.toLowerCase();
            tr.style.display = text.includes(q) ? "" : "none";
          });
        }

        // small toast-like message using Bootstrap's alert (transient)
        function showToast(message, timeout = 1800) {
          const containerId = "live-toast-container";
          let container = document.getElementById(containerId);
          if (!container) {
            container = document.createElement("div");
            container.id = containerId;
            container.style.position = "fixed";
            container.style.right = "20px";
            container.style.bottom = "20px";
            container.style.zIndex = 2000;
            document.body.appendChild(container);
          }

          const alert = document.createElement("div");
          alert.className = "alert alert-success shadow-sm";
          alert.style.marginTop = "8px";
          alert.textContent = message;
          container.appendChild(alert);

          setTimeout(() => {
            alert.classList.add("fade");
            alert.addEventListener("transitionend", () => alert.remove(), {
              once: true,
            });
            alert.style.opacity = 0;
          }, timeout);
        }

        // Delegated event listener for edit/delete buttons in the table
        function tableButtonHandler(e) {
          const btn = e.target.closest("button");
          if (!btn) return;
          const action = btn.getAttribute("data-action");
          const id = btn.getAttribute("data-id");
          if (action === "edit") openEditModal(id);
          if (action === "delete") deletePublisher(id);
        }

        // Setup event listeners
        function initEvents() {
          document
            .getElementById("btnOpenAdd")
            .addEventListener("click", openAddModal);
          document
            .getElementById("savePublisherButton")
            .addEventListener("click", savePublisher);
          document
            .getElementById("publisherSearch")
            .addEventListener("input", applySearch);
          document
            .getElementById("btnSearch")
            .addEventListener("click", applySearch);

          // delegate inside tbody
          document
            .getElementById("publisher-tbody")
            .addEventListener("click", tableButtonHandler);
        }

        // init
        (async function () {
          initEvents();
          await loadPublishers();
        })();

        // expose for debugging (optional)
        window.__publishers = {
          load: loadPublishers,
          openAddModal,
          openEditModal,
          savePublisher,
          deletePublisher,
        };
      })();
    </script>
  </body>
</html>